<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Administrador - Algoritmo</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .login-container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 3rem;
            width: 90%;
            max-width: 450px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.2);
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        
        .logo {
            text-align: center;
            margin-bottom: 2rem;
        }
        
        .logo-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
        }
        
        h1 {
            color: white;
            font-size: 2rem;
            font-weight: 900;
            text-align: center;
            margin-bottom: 0.5rem;
        }
        
        .subtitle {
            color: rgba(255,255,255,0.8);
            text-align: center;
            margin-bottom: 2rem;
            font-size: 0.9rem;
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        label {
            display: block;
            color: white;
            font-weight: 600;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }
        
        input {
            width: 100%;
            padding: 1rem;
            background: rgba(255,255,255,0.9);
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s;
        }
        
        input:focus {
            outline: none;
            background: white;
            box-shadow: 0 0 0 3px rgba(255,255,255,0.3);
        }
        
        .btn-login {
            width: 100%;
            padding: 1rem;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-top: 1rem;
        }
        
        .btn-login:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .btn-login:active {
            transform: translateY(0);
        }
        
        .error-message {
            background: rgba(239, 68, 68, 0.2);
            border: 2px solid #ef4444;
            color: white;
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 1rem;
            display: none;
            text-align: center;
            font-weight: 600;
        }
        
        .admin-panel {
            display: none;
            background: #0f172a;
            min-height: 100vh;
            color: white;
            width: 100%;
        }
        
        .admin-header {
            background: rgba(30, 41, 59, 0.8);
            backdrop-filter: blur(10px);
            padding: 1.5rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid rgba(255,255,255,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .admin-logo {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .admin-logo-icon {
            font-size: 2rem;
        }
        
        .admin-title {
            font-size: 1.5rem;
            font-weight: 900;
        }
        
        .admin-user {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .btn-logout {
            padding: 0.75rem 1.5rem;
            background: rgba(239, 68, 68, 0.2);
            border: 2px solid #ef4444;
            border-radius: 8px;
            color: #ef4444;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-logout:hover {
            background: #ef4444;
            color: white;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1.5rem;
            width: 100%;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 3rem;
        }
        
        .stat-card {
            background: rgba(30, 41, 59, 0.5);
            border-radius: 15px;
            padding: 2rem;
            text-align: center;
            border: 2px solid rgba(255,255,255,0.1);
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .stat-value {
            font-size: 3rem;
            font-weight: 900;
            margin-bottom: 0.5rem;
        }
        
        .stat-label {
            color: rgba(255,255,255,0.7);
            font-size: 1rem;
        }
        
        .tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            overflow-x: auto;
            padding-bottom: 0.5rem;
        }
        
        .tab-btn {
            padding: 1rem 2rem;
            background: rgba(30, 41, 59, 0.5);
            border: 2px solid rgba(255,255,255,0.1);
            border-radius: 10px;
            color: white;
            font-weight: 700;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.3s;
        }
        
        .tab-btn.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-color: transparent;
        }
        
        .tab-content {
            display: none;
            background: rgba(30, 41, 59, 0.5);
            border-radius: 15px;
            padding: 2rem;
            border: 2px solid rgba(255,255,255,0.1);
        }
        
        .tab-content.active {
            display: block;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th {
            background: rgba(255,255,255,0.05);
            padding: 1rem;
            text-align: left;
            font-weight: 700;
            border-bottom: 2px solid rgba(255,255,255,0.1);
        }
        
        td {
            padding: 1rem;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        
        tr:hover {
            background: rgba(255,255,255,0.03);
        }
        
        .badge {
            padding: 0.4rem 0.8rem;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.85rem;
        }
        
        .badge-artista {
            background: rgba(124, 58, 237, 0.2);
            color: #7c3aed;
        }
        
        .badge-curador {
            background: rgba(236, 72, 153, 0.2);
            color: #ec4899;
        }

        .badge-pendiente {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
        }

        .badge-aprobada {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }
        
        .btn-action {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            margin-right: 0.5rem;
            transition: transform 0.2s;
        }
        
        .btn-action:hover {
            transform: scale(1.05);
        }

        .btn-action:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-view {
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
        }
        
        .btn-delete {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .btn-verify {
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
        }

        .btn-approve {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }

        .btn-reject {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }
        
        .search-box {
            width: 100%;
            max-width: 400px;
            padding: 0.75rem 1rem;
            background: rgba(255,255,255,0.05);
            border: 2px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            color: white !important;
            font-size: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .search-box:focus {
            outline: none;
            border-color: rgba(124, 58, 237, 0.8);
            background: rgba(255,255,255,0.1);
        }
        
        .search-box::placeholder {
            color: rgba(255,255,255,0.5);
        }
        
        .filters {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }
        
        .filter-btn {
            padding: 0.6rem 1.2rem;
            background: rgba(255,255,255,0.05);
            border: 2px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .filter-btn.active {
            background: rgba(124, 58, 237, 0.3);
            border-color: #7c3aed;
        }
        
        .config-section {
            background: rgba(255,255,255,0.03);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .config-title {
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
        }
        
        .config-field {
            margin-bottom: 1rem;
        }
        
        .config-label {
            display: block;
            color: rgba(255,255,255,0.8);
            margin-bottom: 0.5rem;
            font-weight: 600;
        }
        
        .config-input {
            width: 200px;
            padding: 0.75rem;
            background: rgba(255,255,255,0.05);
            border: 2px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            color: white;
        }
        
        .btn-save {
            padding: 0.75rem 1.5rem;
            background: #10b981;
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: 700;
            cursor: pointer;
            margin-top: 1rem;
        }
        
        .btn-danger {
            padding: 0.75rem 1.5rem;
            background: rgba(239, 68, 68, 0.2);
            border: 2px solid #ef4444;
            border-radius: 8px;
            color: #ef4444;
            font-weight: 700;
            cursor: pointer;
            margin-right: 1rem;
        }

        .playlist-card {
            background: rgba(255,255,255,0.03);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 2px solid rgba(255,255,255,0.1);
        }

        .playlist-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 1rem;
        }

        .playlist-title {
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .playlist-info {
            color: rgba(255,255,255,0.7);
            font-size: 0.9rem;
            line-height: 1.6;
        }

        .spotify-data {
            background: rgba(16, 185, 129, 0.1);
            border: 2px solid rgba(16, 185, 129, 0.3);
            border-radius: 10px;
            padding: 1rem;
            margin: 1rem 0;
        }

        .spotify-data h4 {
            color: #10b981;
            margin-bottom: 0.75rem;
            font-size: 1.1rem;
        }

        .data-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
        }

        .data-item {
            font-size: 0.9rem;
        }

        .data-label {
            color: rgba(255,255,255,0.6);
            margin-bottom: 0.25rem;
        }

        .data-value {
            color: white;
            font-weight: 600;
        }

        /* Modal de verificaci√≥n */
        .verify-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .verify-modal.active {
            display: flex;
        }

        .verify-modal-content {
            background: #1e293b;
            border-radius: 1rem;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }

        .verify-modal h3 {
            font-size: 1.5rem;
            margin-bottom: 1.5rem;
            color: white;
        }

        .verify-field {
            margin-bottom: 1.5rem;
        }

        .verify-field label {
            display: block;
            color: rgba(255,255,255,0.8);
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        .verify-field input {
            width: 100%;
            padding: 0.75rem;
            background: rgba(255,255,255,0.05);
            border: 2px solid rgba(255,255,255,0.1);
            border-radius: 0.5rem;
            color: white;
            font-size: 1rem;
        }

        .verify-field input:focus {
            outline: none;
            border-color: #7c3aed;
            background: rgba(255,255,255,0.1);
        }

        .verify-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
        }

        .verify-buttons button {
            flex: 1;
            padding: 0.75rem;
            border: none;
            border-radius: 0.5rem;
            font-weight: 700;
            cursor: pointer;
            font-size: 1rem;
        }

        .btn-verify-submit {
            background: #10b981;
            color: white;
        }

        .btn-verify-cancel {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }
    </style>
</head>
<body>
    <!-- Pantalla de Login -->
    <div class="login-container" id="loginScreen">
        <div class="logo">
            <div class="logo-icon">üëë</div>
            <h1>Panel de Administrador</h1>
            <p class="subtitle">Acceso restringido solo para administradores</p>
        </div>
        
        <div class="error-message" id="errorMessage">
            ‚ö†Ô∏è Credenciales incorrectas
        </div>
        
        <form id="loginForm" onsubmit="handleLogin(event)">
            <div class="form-group">
                <label for="adminEmail">Email de Administrador</label>
                <input type="email" id="adminEmail" required placeholder="admin@algoritmo.com">
            </div>
            
            <div class="form-group">
                <label for="adminPassword">Contrase√±a</label>
                <input type="password" id="adminPassword" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
            </div>
            
            <button type="submit" class="btn-login">
                üîê Iniciar Sesi√≥n
            </button>
        </form>
    </div>

    <!-- Panel de Administrador -->
    <div class="admin-panel" id="adminPanel">
        <header class="admin-header">
            <div class="admin-logo">
                <div class="admin-logo-icon">üëë</div>
                <div class="admin-title">Panel de Administrador</div>
            </div>
            <div class="admin-user">
                <span id="adminName">Admin</span>
                <button class="btn-logout" onclick="logout()">üö™ Cerrar Sesi√≥n</button>
            </div>
        </header>

        <div class="container">
            <!-- Estad√≠sticas -->
            <div class="stats-grid">
                <div class="stat-card" style="border-color: #10b981;">
                    <div class="stat-value" style="color: #10b981;" id="totalUsuarios">0</div>
                    <div class="stat-label">Total Usuarios</div>
                </div>
                <div class="stat-card" style="border-color: #7c3aed;">
                    <div class="stat-value" style="color: #7c3aed;" id="totalArtistas">0</div>
                    <div class="stat-label">Artistas</div>
                </div>
                <div class="stat-card" style="border-color: #ec4899;">
                    <div class="stat-value" style="color: #ec4899;" id="totalCuradores">0</div>
                    <div class="stat-label">Curadores</div>
                </div>
                <div class="stat-card" style="border-color: #fbbf24;">
                    <div class="stat-value" style="color: #fbbf24;" id="playlistsPendientes">0</div>
                    <div class="stat-label">Playlists Pendientes</div>
                </div>
                <div class="stat-card" style="border-color: #06b6d4;">
                    <div class="stat-value" style="color: #06b6d4;" id="afiliadosPendientes">0</div>
                    <div class="stat-label">Afiliados Pendientes</div>
                </div>
                <div class="stat-card" style="border-color: #f59e0b;">
                    <div class="stat-value" style="color: #f59e0b;" id="retirosPendientes">0</div>
                    <div class="stat-label">Retiros Pendientes</div>
                </div>
                <div class="stat-card" style="border-color: #eab308;">
                    <div class="stat-value" style="color: #eab308;" id="destacarPendientes">0</div>
                    <div class="stat-label">Destacar Pendientes</div>
                </div>
                <div class="stat-card" style="border-color: #f472b6;">
                    <div class="stat-value" style="color: #f472b6;" id="canjesPendientes">0</div>
                    <div class="stat-label">Canjes Pendientes</div>
                </div>
            </div>

            <!-- Tabs -->
            <div class="tabs">
                <button class="tab-btn active" onclick="changeTab('usuarios')">üë• Usuarios</button>
                <button class="tab-btn" onclick="changeTab('aprobarPlaylists')">üìã Aprobar Playlists</button>
                <button class="tab-btn" onclick="changeTab('transacciones')">üí∞ Transacciones</button>
                <button class="tab-btn" onclick="changeTab('envios')">üì® Env√≠os</button>
                <button class="tab-btn" onclick="changeTab('playlists')">üéµ Playlists</button>
                <button class="tab-btn" onclick="changeTab('pedidos')">üõí Pedidos</button>
                <button class="tab-btn" onclick="changeTab('afiliados')">ü§ù Afiliados</button>
                <button class="tab-btn" onclick="changeTab('comisionesAfiliados')">üí∏ Comisiones</button>
                <button class="tab-btn" onclick="changeTab('retiros')">üè¶ Retiros</button>
                <button class="tab-btn" onclick="changeTab('destacar')">‚≠ê Destacar</button>
                <button class="tab-btn" onclick="changeTab('canjes')">üì¶ Canjes</button>
                <button class="tab-btn" onclick="changeTab('reportes')">üìä Reportes</button>
                <button class="tab-btn" onclick="changeTab('configuracion')">‚öôÔ∏è Configuraci√≥n</button>
            </div>

            <!-- Tab: Usuarios -->
            <div class="tab-content active" id="tabUsuarios">
                <h2 style="font-size: 1.8rem; font-weight: 800; margin-bottom: 1.5rem;">üë• Gesti√≥n de Usuarios</h2>
                
                <input type="text" class="search-box" id="searchUsuarios" placeholder="üîç Buscar usuario..." oninput="filtrarUsuarios()">
                
                <div class="filters">
                    <button class="filter-btn active" onclick="filtrarPorTipo('todos')">Todos</button>
                    <button class="filter-btn" onclick="filtrarPorTipo('artista')">Artistas</button>
                    <button class="filter-btn" onclick="filtrarPorTipo('curador')">Curadores</button>
                </div>
                
                <div style="overflow-x: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>Usuario</th>
                                <th>Email</th>
                                <th>Tipo</th>
                                <th>Fecha Registro</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tablaUsuarios">
                            <tr>
                                <td colspan="5" style="text-align: center; padding: 3rem; color: rgba(255,255,255,0.5);">
                                    Cargando usuarios...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Tab: APROBAR PLAYLISTS (NUEVO) -->
            <div class="tab-content" id="tabAprobarPlaylists">
                <h2 style="font-size: 1.8rem; font-weight: 800; margin-bottom: 1.5rem;">üìã Aprobar Playlists Pendientes</h2>
                
                <div id="playlistsPendientesContainer">
                    <div style="text-align: center; padding: 3rem; color: rgba(255,255,255,0.5);">
                        ‚è≥ Cargando playlists pendientes...
                    </div>
                </div>
            </div>

            <!-- Tab: Transacciones -->
            <div class="tab-content" id="tabTransacciones">
                <h2 style="font-size: 1.8rem; font-weight: 800; margin-bottom: 1.5rem;">üí∞ Historial de Transacciones</h2>
                
                <div class="filters">
                    <button class="filter-btn active" onclick="filtrarTransaccionesPorEstado('todos')">üìä Todos</button>
                    <button class="filter-btn" onclick="filtrarTransaccionesPorEstado('completado')">‚úÖ Completados</button>
                    <button class="filter-btn" onclick="filtrarTransaccionesPorEstado('pendiente')">‚è≥ Pendientes</button>
                    <button class="filter-btn" onclick="filtrarTransaccionesPorEstado('cancelado')">‚ùå Cancelados</button>
                </div>

                <div style="overflow-x: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>Usuario</th>
                                <th>Tipo</th>
                                <th>Monto</th>
                                <th>Estado</th>
                                <th>Fecha</th>
                            </tr>
                        </thead>
                        <tbody id="tablaTransacciones">
                            <tr>
                                <td colspan="5" style="text-align: center; padding: 3rem; color: rgba(255,255,255,0.5);">
                                    Cargando transacciones...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Tab: Env√≠os -->
            <div class="tab-content" id="tabEnvios">
                <h2 style="font-size: 1.8rem; font-weight: 800; margin-bottom: 1.5rem;">üì® Gesti√≥n de Env√≠os</h2>
                
                <div class="filters">
                    <button class="filter-btn active" onclick="filtrarEnviosPorEstado('todos')">üìä Todos</button>
                    <button class="filter-btn" onclick="filtrarEnviosPorEstado('pendiente')">‚è≥ Pendientes</button>
                    <button class="filter-btn" onclick="filtrarEnviosPorEstado('aceptado')">‚úÖ Aceptados</button>
                    <button class="filter-btn" onclick="filtrarEnviosPorEstado('rechazado')">‚ùå Rechazados</button>
                </div>

                <div style="overflow-x: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>Artista</th>
                                <th>Canci√≥n</th>
                                <th>Playlist</th>
                                <th>Curador</th>
                                <th>Estado</th>
                                <th>Fecha</th>
                            </tr>
                        </thead>
                        <tbody id="tablaEnvios">
                            <tr>
                                <td colspan="6" style="text-align: center; padding: 3rem; color: rgba(255,255,255,0.5);">
                                    Cargando env√≠os...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Tab: Playlists -->
            <div class="tab-content" id="tabPlaylists">
                <h2 style="font-size: 1.8rem; font-weight: 800; margin-bottom: 1.5rem;">üéµ Todas las Playlists</h2>
                
                <div class="filters">
                    <button class="filter-btn active" onclick="filtrarPlaylistsPorEstado('todas')">üìä Todas</button>
                    <button class="filter-btn" onclick="filtrarPlaylistsPorEstado('aprobada')">‚úÖ Aprobadas</button>
                    <button class="filter-btn" onclick="filtrarPlaylistsPorEstado('pendiente')">‚è≥ Pendientes</button>
                    <button class="filter-btn" onclick="filtrarPlaylistsPorEstado('rechazada')">‚ùå Rechazadas</button>
                </div>

                <div style="overflow-x: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>Nombre</th>
                                <th>Curador</th>
                                <th>Seguidores</th>
                                <th>Estado</th>
                                <th>Fecha</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tablaTodasPlaylists">
                            <tr>
                                <td colspan="6" style="text-align: center; padding: 3rem; color: rgba(255,255,255,0.5);">
                                    Cargando playlists...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Tab: Reportes -->
            <div class="tab-content" id="tabReportes">
                <h2 style="font-size: 1.8rem; font-weight: 800; margin-bottom: 1.5rem;">üìä Reportes y Estad√≠sticas</h2>
                
                <div class="stats-grid" style="margin-bottom: 2rem;">
                    <div class="stat-card" style="border-color: #10b981;">
                        <div class="stat-value" style="color: #10b981;" id="ingresosDelMes">0‚Ç¨</div>
                        <div class="stat-label">üí∏ Ingresos del Mes</div>
                    </div>
                    <div class="stat-card" style="border-color: #7c3aed;">
                        <div class="stat-value" style="color: #7c3aed;" id="enviosDelMes">0</div>
                        <div class="stat-label">üéµ Env√≠os del Mes</div>
                    </div>
                    <div class="stat-card" style="border-color: #ec4899;">
                        <div class="stat-value" style="color: #ec4899;" id="nuevosUsuarios">0</div>
                        <div class="stat-label">üë• Nuevos Usuarios</div>
                    </div>
                    <div class="stat-card" style="border-color: #fbbf24;">
                        <div class="stat-value" style="color: #fbbf24;" id="totalTransacciones">0</div>
                        <div class="stat-label">üí∞ Total Transacciones</div>
                    </div>
                </div>

                <h3 style="font-size: 1.3rem; font-weight: 700; margin-bottom: 1rem;">‚ö†Ô∏è Reportes de Usuarios</h3>
                
                <div style="overflow-x: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>Usuario</th>
                                <th>Tipo</th>
                                <th>Descripci√≥n</th>
                                <th>Estado</th>
                                <th>Fecha</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tablaReportesUsuarios">
                            <tr>
                                <td colspan="6" style="text-align: center; padding: 2rem; color: rgba(255,255,255,0.5);">
                                    Cargando reportes de usuarios...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Tab: Configuraci√≥n -->
            <div class="tab-content" id="tabConfiguracion">
                <h2 style="font-size: 1.8rem; font-weight: 800; margin-bottom: 1.5rem;">‚öôÔ∏è Configuraci√≥n de la Plataforma</h2>
                
                <div class="config-section">
                    <h3 class="config-title">üí∞ Configuraci√≥n de Precios</h3>
                    <div class="config-field">
                        <label class="config-label">Precio Standard (‚Ç¨):</label>
                        <input type="number" class="config-input" id="precioStandard" value="0.50" step="0.10">
                    </div>
                    <div class="config-field">
                        <label class="config-label">Precio Premium (‚Ç¨):</label>
                        <input type="number" class="config-input" id="precioPremium" value="2.00" step="0.10">
                    </div>
                    <button class="btn-save" onclick="guardarPrecios()">üíæ Guardar Cambios</button>
                </div>

                <div class="config-section">
                    <h3 class="config-title">üìä Comisiones</h3>
                    <div class="config-field">
                        <label class="config-label">Comisi√≥n Plataforma (%):</label>
                        <input type="number" class="config-input" id="comisionPlataforma" value="5" step="1" min="0" max="100">
                    </div>
                    <div class="config-field">
                        <label class="config-label">Comisi√≥n Referidos (%):</label>
                        <input type="number" class="config-input" id="comisionReferidos" value="15" step="1" min="0" max="100">
                    </div>
                    <button class="btn-save" onclick="guardarComisiones()">üíæ Guardar Cambios</button>
                </div>

                <div class="config-section">
                    <h3 class="config-title">üîß Mantenimiento</h3>
                    <button class="btn-danger" onclick="limpiarCache()">üßπ Limpiar Cach√©</button>
                    <button class="btn-danger" onclick="resetearDatos()">‚ö†Ô∏è Resetear Datos Demo</button>
                </div>
            </div>

            <!-- Tab: Afiliados -->
            <div class="tab-content" id="tabAfiliados">
                <h2 style="font-size: 1.8rem; font-weight: 800; margin-bottom: 1.5rem;">ü§ù Gesti√≥n de Afiliados</h2>
                
                <div class="filters">
                    <button class="filter-btn active" onclick="filtrarAfiliados('todos')">üìä Todos</button>
                    <button class="filter-btn" onclick="filtrarAfiliados('pendiente')">‚è≥ Pendientes</button>
                    <button class="filter-btn" onclick="filtrarAfiliados('aceptado')">‚úÖ Aprobados</button>
                    <button class="filter-btn" onclick="filtrarAfiliados('rechazado')">‚ùå Rechazados</button>
                </div>
                
                <div style="overflow-x: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>Nombre</th>
                                <th>Email</th>
                                <th>Instagram</th>
                                <th>C√≥digo</th>
                                <th>Estado</th>
                                <th>Fecha</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tablaAfiliados">
                            <tr><td colspan="7" style="text-align: center; padding: 2rem; color: rgba(255,255,255,0.5);">Cargando afiliados...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Tab: Comisiones de Afiliados -->
            <div class="tab-content" id="tabComisionesAfiliados">
                <h2 style="font-size: 1.8rem; font-weight: 800; margin-bottom: 1.5rem;">üí∏ Comisiones de Afiliados</h2>
                
                <div class="stats-grid" style="margin-bottom: 2rem;">
                    <div class="stat-card" style="border-color: #10b981;">
                        <div class="stat-value" style="color: #10b981;" id="totalComisiones">‚Ç¨0</div>
                        <div class="stat-label">Total Comisiones</div>
                    </div>
                    <div class="stat-card" style="border-color: #fbbf24;">
                        <div class="stat-value" style="color: #fbbf24;" id="comisionesPendientesTotal">‚Ç¨0</div>
                        <div class="stat-label">Pendientes de Pago</div>
                    </div>
                    <div class="stat-card" style="border-color: #3b82f6;">
                        <div class="stat-value" style="color: #3b82f6;" id="comisionesPagadas">‚Ç¨0</div>
                        <div class="stat-label">Pagadas</div>
                    </div>
                </div>
                
                <div class="filters">
                    <button class="filter-btn active" onclick="filtrarComisiones('todos')">üìä Todas</button>
                    <button class="filter-btn" onclick="filtrarComisiones('pendiente')">‚è≥ Pendientes</button>
                    <button class="filter-btn" onclick="filtrarComisiones('confirmado')">‚úÖ Confirmadas</button>
                    <button class="filter-btn" onclick="filtrarComisiones('pagado')">üí∞ Pagadas</button>
                </div>
                
                <div style="overflow-x: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>Afiliado</th>
                                <th>Comprador</th>
                                <th>Tipo Compra</th>
                                <th>Monto</th>
                                <th>Comisi√≥n (15%)</th>
                                <th>Estado</th>
                                <th>Fecha</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tablaComisiones">
                            <tr><td colspan="8" style="text-align: center; padding: 2rem; color: rgba(255,255,255,0.5);">Cargando comisiones...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Tab: Retiros -->
            <div class="tab-content" id="tabRetiros">
                <h2 style="font-size: 1.8rem; font-weight: 800; margin-bottom: 1.5rem;">üè¶ Solicitudes de Retiro</h2>
                
                <div class="stats-grid" style="margin-bottom: 2rem;">
                    <div class="stat-card" style="border-color: #f59e0b;">
                        <div class="stat-value" style="color: #f59e0b;" id="totalRetirosPendientes">‚Ç¨0</div>
                        <div class="stat-label">Pendientes de Pago</div>
                    </div>
                    <div class="stat-card" style="border-color: #10b981;">
                        <div class="stat-value" style="color: #10b981;" id="totalRetirosCompletados">‚Ç¨0</div>
                        <div class="stat-label">Pagados Este Mes</div>
                    </div>
                </div>
                
                <div class="filters">
                    <button class="filter-btn active" onclick="filtrarRetiros('todos')">üìä Todos</button>
                    <button class="filter-btn" onclick="filtrarRetiros('pendiente')">‚è≥ Pendientes</button>
                    <button class="filter-btn" onclick="filtrarRetiros('completado')">‚úÖ Completados</button>
                    <button class="filter-btn" onclick="filtrarRetiros('rechazado')">‚ùå Rechazados</button>
                </div>
                
                <div style="overflow-x: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>Usuario</th>
                                <th>Tipo</th>
                                <th>Monto</th>
                                <th>M√©todo</th>
                                <th>Datos Pago</th>
                                <th>Estado</th>
                                <th>Fecha</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tablaRetiros">
                            <tr><td colspan="8" style="text-align: center; padding: 2rem; color: rgba(255,255,255,0.5);">Cargando retiros...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Tab: Destacar Playlists -->
            <div class="tab-content" id="tabDestacar">
                <h2 style="font-size: 1.8rem; font-weight: 800; margin-bottom: 1.5rem;">‚≠ê Solicitudes Destacar Playlist</h2>
                
                <div class="stats-grid" style="margin-bottom: 2rem;">
                    <div class="stat-card" style="border-color: #eab308;">
                        <div class="stat-value" style="color: #eab308;" id="totalDestacarPendientes">0</div>
                        <div class="stat-label">Solicitudes Pendientes</div>
                    </div>
                    <div class="stat-card" style="border-color: #10b981;">
                        <div class="stat-value" style="color: #10b981;" id="totalDestacarActivas">0</div>
                        <div class="stat-label">Playlists Destacadas</div>
                    </div>
                    <div class="stat-card" style="border-color: #8b5cf6;">
                        <div class="stat-value" style="color: #8b5cf6;" id="ingresoDestacar">‚Ç¨0</div>
                        <div class="stat-label">Ingresos Este Mes</div>
                    </div>
                </div>
                
                <div class="filters">
                    <button class="filter-btn active" onclick="filtrarDestacar('todos')">üìä Todos</button>
                    <button class="filter-btn" onclick="filtrarDestacar('pendiente')">‚è≥ Pendientes</button>
                    <button class="filter-btn" onclick="filtrarDestacar('aprobado')">‚úÖ Aprobados</button>
                    <button class="filter-btn" onclick="filtrarDestacar('rechazado')">‚ùå Rechazados</button>
                </div>
                
                <div style="overflow-x: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>Curador</th>
                                <th>Playlist</th>
                                <th>Precio</th>
                                <th>Estado</th>
                                <th>Fecha</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tablaDestacar">
                            <tr><td colspan="6" style="text-align: center; padding: 2rem; color: rgba(255,255,255,0.5);">Cargando solicitudes...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Tab: Canjes de Servicios -->
            <div class="tab-content" id="tabCanjes">
                <h2 style="font-size: 1.8rem; font-weight: 800; margin-bottom: 1.5rem;">üì¶ Canjes de Servicios</h2>
                
                <div class="stats-grid" style="margin-bottom: 2rem;">
                    <div class="stat-card" style="border-color: #f472b6;">
                        <div class="stat-value" style="color: #f472b6;" id="totalCanjesPendientes">0</div>
                        <div class="stat-label">Canjes Pendientes</div>
                    </div>
                    <div class="stat-card" style="border-color: #10b981;">
                        <div class="stat-value" style="color: #10b981;" id="totalCanjesCompletados">0</div>
                        <div class="stat-label">Completados Este Mes</div>
                    </div>
                    <div class="stat-card" style="border-color: #8b5cf6;">
                        <div class="stat-value" style="color: #8b5cf6;" id="totalPuntosCanjeados">0</div>
                        <div class="stat-label">Puntos Canjeados</div>
                    </div>
                </div>
                
                <div class="filters">
                    <button class="filter-btn active" onclick="filtrarCanjes('todos')">üìä Todos</button>
                    <button class="filter-btn" onclick="filtrarCanjes('pendiente')">‚è≥ Pendientes</button>
                    <button class="filter-btn" onclick="filtrarCanjes('aprobado')">‚úÖ Aprobados</button>
                    <button class="filter-btn" onclick="filtrarCanjes('rechazado')">‚ùå Rechazados</button>
                </div>
                
                <div style="overflow-x: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>Curador</th>
                                <th>Servicio</th>
                                <th>Puntos</th>
                                <th>Estado</th>
                                <th>Fecha</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tablaCanjes">
                            <tr><td colspan="6" style="text-align: center; padding: 2rem; color: rgba(255,255,255,0.5);">Cargando canjes...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

            <!-- Tab: Pedidos (Unificado) -->
            <div class="tab-content" id="tabPedidos">
                <h2 style="font-size: 1.8rem; font-weight: 800; margin-bottom: 1.5rem;">üõí Todos los Pedidos</h2>
                
                <!-- Estad√≠sticas r√°pidas -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                    <div style="background: rgba(124, 58, 237, 0.2); padding: 1rem; border-radius: 1rem; text-align: center;">
                        <div style="font-size: 1.5rem; font-weight: 900;" id="pedidosSmartlinks">0</div>
                        <div style="font-size: 0.75rem; color: rgba(255,255,255,0.7);">üîó SmartLinks</div>
                    </div>
                    <div style="background: rgba(236, 72, 153, 0.2); padding: 1rem; border-radius: 1rem; text-align: center;">
                        <div style="font-size: 1.5rem; font-weight: 900;" id="pedidosMastering">0</div>
                        <div style="font-size: 0.75rem; color: rgba(255,255,255,0.7);">üéõÔ∏è Mastering</div>
                    </div>
                    <div style="background: rgba(139, 92, 246, 0.2); padding: 1rem; border-radius: 1rem; text-align: center;">
                        <div style="font-size: 1.5rem; font-weight: 900;" id="pedidosAnalisis">0</div>
                        <div style="font-size: 0.75rem; color: rgba(255,255,255,0.7);">üìä An√°lisis</div>
                    </div>
                </div>
                
                <!-- Filtros -->
                <div style="display: flex; gap: 0.5rem; margin-bottom: 1.5rem; flex-wrap: wrap;">
                    <button class="filter-btn active" onclick="filtrarPedidos('todos')">Todos</button>
                    <button class="filter-btn" onclick="filtrarPedidos('pendiente')">‚è≥ Pendientes</button>
                    <button class="filter-btn" onclick="filtrarPedidos('completado')">‚úÖ Completados</button>
                    <button class="filter-btn" onclick="filtrarPedidos('smartlink')">üîó SmartLinks</button>
                    <button class="filter-btn" onclick="filtrarPedidos('mastering')">üéõÔ∏è Mastering</button>
                    <button class="filter-btn" onclick="filtrarPedidos('analisis')">üìä An√°lisis</button>
                </div>
                
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Tipo</th>
                                <th>Cliente</th>
                                <th>Detalles</th>
                                <th>Precio</th>
                                <th>Estado</th>
                                <th>Fecha</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tablaPedidos">
                            <tr><td colspan="7" style="text-align: center; padding: 2rem;">Cargando pedidos...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
    </div>

    <!-- Modal de Verificaci√≥n -->
    <div class="verify-modal" id="verifyModal">
        <div class="verify-modal-content">
            <h3>üîç Verificar Datos de Spotify</h3>
            <p style="color: rgba(255,255,255,0.7); margin-bottom: 1.5rem;">
                Se ha abierto la playlist en Spotify. Revisa los datos y completa el formulario:
            </p>
            
            <div class="verify-field">
                <label for="verifyFollowers">üë• N√∫mero de Seguidores:</label>
                <input type="number" id="verifyFollowers" placeholder="Ej: 1234" required>
            </div>
            
            <div class="verify-field">
                <label for="verifyName">üéµ Nombre de la Playlist:</label>
                <input type="text" id="verifyName" placeholder="Nombre exacto" required>
            </div>

            <div style="background: rgba(59, 130, 246, 0.1); padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem;">
                <small style="color: rgba(255,255,255,0.8);">
                    üí° Verifica que el due√±o de la playlist coincida con el email del curador
                </small>
            </div>
            
            <div class="verify-buttons">
                <button class="btn-verify-cancel" onclick="closeVerifyModal()">‚ùå Cancelar</button>
                <button class="btn-verify-submit" onclick="submitVerification()">‚úÖ Verificar</button>
            </div>
        </div>
    </div>

    <script>
        // ========================================
        // CONFIGURACI√ìN SUPABASE
        // ========================================
        const SUPABASE_URL = 'https://wesmqqaijlmqhctrtaje.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_LgSAsCVW7tlDfDvkD8enyA_pQp42IZF';
        
        let supabaseClient;
        if (typeof supabase !== 'undefined') {
            supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            console.log('‚úÖ Supabase inicializado en Admin Panel');
        } else {
            console.error('‚ùå Supabase no est√° disponible');
        }
        
        // ========================================
        // CREDENCIALES DE ADMINISTRADOR
        // ========================================
        const ADMIN_CREDENTIALS = {
            email: 'micael@algoritmo.com',
            password: 'Algoritmo2026!'
        };

        // ========================================
        // LOGIN DE ADMINISTRADOR
        // ========================================
        async function handleLogin(event) {
            event.preventDefault();
            
            const email = document.getElementById('adminEmail').value;
            const password = document.getElementById('adminPassword').value;
            
            if (email === ADMIN_CREDENTIALS.email && password === ADMIN_CREDENTIALS.password) {
                // Login exitoso
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('adminPanel').style.display = 'block';
                
                // Guardar sesi√≥n
                sessionStorage.setItem('adminLoggedIn', 'true');
                sessionStorage.setItem('adminEmail', email);
                
                // Cargar datos REALES de Supabase
                await cargarUsuariosReales();
                await cargarPlaylistsPendientes();
                await cargarTodasPlaylists();
                await cargarTransacciones();
                await cargarTodosEnvios();
                await cargarReportes();
                await cargarAfiliados();
                await cargarRetiros();
                
                console.log('‚úÖ Login de administrador exitoso');
            } else {
                // Login fallido
                document.getElementById('errorMessage').style.display = 'block';
                setTimeout(() => {
                    document.getElementById('errorMessage').style.display = 'none';
                }, 3000);
                console.log('‚ùå Credenciales incorrectas');
            }
        }

        // Logout
        function logout() {
            if (confirm('¬øCerrar sesi√≥n de administrador?')) {
                sessionStorage.clear();
                location.reload();
            }
        }

        // Cambiar tab
        function changeTab(tabName) {
            // Ocultar todos los tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Mostrar tab seleccionado
            document.getElementById('tab' + tabName.charAt(0).toUpperCase() + tabName.slice(1)).classList.add('active');
            event.target.classList.add('active');

            // Cargar datos seg√∫n la tab
            if (tabName === 'aprobarPlaylists') {
                cargarPlaylistsPendientes();
            } else if (tabName === 'transacciones') {
                cargarTransacciones();
            } else if (tabName === 'playlists') {
                cargarTodasPlaylists();
            } else if (tabName === 'envios') {
                cargarTodosEnvios();
            } else if (tabName === 'reportes') {
                cargarReportes();
            } else if (tabName === 'afiliados') {
                cargarAfiliados();
            } else if (tabName === 'comisionesAfiliados') {
                cargarComisionesAfiliados();
            } else if (tabName === 'retiros') {
                cargarRetiros();
            } else if (tabName === 'destacar') {
                cargarSolicitudesDestacar();
            } else if (tabName === 'canjes') {
                cargarCanjes();
            } else if (tabName === 'pedidos') {
                cargarTodosPedidos();
            }
        }

        // ========================================
        // CARGAR USUARIOS REALES DE SUPABASE
        // ========================================
        async function cargarUsuariosReales() {
            try {
                console.log('üîÑ Cargando usuarios de Supabase...');
                
                const { data: usuarios, error } = await supabaseClient
                    .from('usuarios')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) {
                    console.error('‚ùå Error al cargar usuarios:', error);
                    alert('Error al cargar usuarios');
                    return;
                }
                
                console.log('‚úÖ Usuarios cargados:', usuarios);
                
                const tbody = document.getElementById('tablaUsuarios');
                tbody.innerHTML = '';
                
                if (!usuarios || usuarios.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 2rem; color: rgba(255,255,255,0.5);">No hay usuarios registrados</td></tr>';
                    document.getElementById('totalUsuarios').textContent = '0';
                    document.getElementById('totalArtistas').textContent = '0';
                    document.getElementById('totalCuradores').textContent = '0';
                    return;
                }
                
                usuarios.forEach(user => {
                    const badgeClass = user.tipo === 'artista' ? 'badge-artista' : 'badge-curador';
                    const icon = user.tipo === 'artista' ? 'üéµ' : 'üéß';
                    const fecha = new Date(user.created_at).toLocaleDateString('es-ES');
                    
                    // Bot√≥n de ver playlists solo para curadores
                    const btnPlaylists = user.tipo === 'curador' 
                        ? `<button class="btn-action" style="background: #8b5cf6;" onclick="verPlaylistsCurador('${user.id}', '${user.nombre}')">üìã Playlists</button>`
                        : '';
                    
                    tbody.innerHTML += `
                        <tr>
                            <td>${user.nombre}</td>
                            <td style="color: rgba(255,255,255,0.7);">${user.email}</td>
                            <td><span class="badge ${badgeClass}">${icon} ${user.tipo.charAt(0).toUpperCase() + user.tipo.slice(1)}</span></td>
                            <td style="color: rgba(255,255,255,0.7);">${fecha}</td>
                            <td>
                                <button class="btn-action btn-view" onclick="verUsuario('${user.id}', '${user.email}')">üëÅÔ∏è Ver</button>
                                ${btnPlaylists}
                                <button class="btn-action btn-delete" onclick="eliminarUsuario('${user.id}', '${user.email}')">üóëÔ∏è Eliminar</button>
                            </td>
                        </tr>
                    `;
                });
                
                // Actualizar estad√≠sticas
                document.getElementById('totalUsuarios').textContent = usuarios.length;
                document.getElementById('totalArtistas').textContent = usuarios.filter(u => u.tipo === 'artista').length;
                document.getElementById('totalCuradores').textContent = usuarios.filter(u => u.tipo === 'curador').length;
                
            } catch (err) {
                console.error('‚ùå Error inesperado:', err);
                alert('Error al cargar datos');
            }
        }

        // ========================================
        // CARGAR PLAYLISTS PENDIENTES
        // ========================================
        async function cargarPlaylistsPendientes() {
            try {
                console.log('üîÑ Cargando playlists pendientes...');
                
                const { data: playlists, error } = await supabaseClient
                    .from('playlists')
                    .select(`
                        id,
                        nombre,
                        url_spotify,
                        spotify_playlist_id,
                        followers,
                        created_at,
                        usuarios!playlists_curador_id_fkey (
                            nombre,
                            email
                        )
                    `)
                    .eq('estado', 'pendiente')
                    .order('created_at', { ascending: false });
                
                if (error) {
                    console.error('‚ùå Error:', error);
                    throw error;
                }
                
                const container = document.getElementById('playlistsPendientesContainer');
                
                if (!playlists || playlists.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 3rem; color: rgba(255,255,255,0.5);">
                            <h3 style="font-size: 2rem; margin-bottom: 1rem;">‚úÖ ¬°Todo revisado!</h3>
                            <p>No hay playlists pendientes de aprobaci√≥n</p>
                        </div>
                    `;
                    document.getElementById('playlistsPendientes').textContent = '0';
                    return;
                }
                
                document.getElementById('playlistsPendientes').textContent = playlists.length;
                
                container.innerHTML = playlists.map(playlist => `
                    <div class="playlist-card" id="playlist-${playlist.id}">
                        <div class="playlist-header">
                            <div>
                                <div class="playlist-title">${playlist.nombre || 'Sin nombre'}</div>
                                <div class="playlist-info">
                                    üë§ Curador: <strong>${playlist.usuarios?.nombre || 'Desconocido'}</strong><br>
                                    üìß Email: ${playlist.usuarios?.email || 'N/A'}<br>
                                    üìÖ Enviado: ${new Date(playlist.created_at).toLocaleString('es-ES')}<br>
                                    üîó <a href="${playlist.url_spotify || '#'}" target="_blank" style="color: #1db954;">Ver en Spotify</a>
                                </div>
                            </div>
                            <span class="badge badge-pendiente">‚è≥ PENDIENTE</span>
                        </div>
                        
                        <div id="spotifyData-${playlist.id}"></div>
                        
                        <div style="display: flex; gap: 1rem; margin-top: 1rem; flex-wrap: wrap;">
                            <button class="btn-action btn-verify" onclick="verificarPlaylist('${playlist.id}', '${playlist.spotify_playlist_id || ''}')">
                                üîç Verificar Datos
                            </button>
                            <button class="btn-action btn-approve" onclick="aprobarPlaylist('${playlist.id}')" id="btnAprobar-${playlist.id}" disabled>
                                ‚úÖ Aprobar
                            </button>
                            <button class="btn-action btn-reject" onclick="rechazarPlaylist('${playlist.id}')">
                                ‚ùå Rechazar
                            </button>
                        </div>
                    </div>
                `).join('');
                
            } catch (err) {
                console.error('‚ùå Error:', err);
                document.getElementById('playlistsPendientesContainer').innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: rgba(255,255,255,0.5);">
                        <h3 style="color: #ef4444; margin-bottom: 1rem;">‚ö†Ô∏è Error</h3>
                        <p>${err.message}</p>
                    </div>
                `;
            }
        }

        // ========================================
        // CARGAR TODAS LAS PLAYLISTS
        // ========================================
        async function cargarTodasPlaylists() {
            try {
                console.log('üîÑ Cargando todas las playlists...');
                
                const { data: playlists, error } = await supabaseClient
                    .from('playlists')
                    .select(`
                        id,
                        nombre,
                        followers,
                        estado,
                        url_spotify,
                        created_at,
                        motivo_rechazo,
                        usuarios!playlists_curador_id_fkey (
                            nombre,
                            email
                        )
                    `)
                    .order('created_at', { ascending: false });
                
                if (error) {
                    console.error('‚ùå Error:', error);
                    throw error;
                }
                
                const tbody = document.getElementById('tablaTodasPlaylists');
                
                if (!playlists || playlists.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 2rem; color: rgba(255,255,255,0.5);">No hay playlists registradas</td></tr>';
                    return;
                }
                
                tbody.innerHTML = '';
                
                playlists.forEach(playlist => {
                    let estadoBadge = '';
                    let estadoClass = '';
                    
                    if (playlist.estado === 'aprobada') {
                        estadoBadge = '‚úÖ Aprobada';
                        estadoClass = 'badge-aprobada';
                    } else if (playlist.estado === 'pendiente') {
                        estadoBadge = '‚è≥ Pendiente';
                        estadoClass = 'badge-pendiente';
                    } else if (playlist.estado === 'rechazada') {
                        estadoBadge = '‚ùå Rechazada';
                        estadoClass = 'badge';
                    }
                    
                    const fecha = new Date(playlist.created_at).toLocaleDateString('es-ES');
                    
                    tbody.innerHTML += `
                        <tr data-estado="${playlist.estado}">
                            <td>
                                <strong>${playlist.nombre || 'Sin nombre'}</strong>
                                ${playlist.motivo_rechazo ? `<br><small style="color: #ef4444;">Motivo: ${playlist.motivo_rechazo}</small>` : ''}
                            </td>
                            <td style="color: rgba(255,255,255,0.7);">
                                ${playlist.usuarios?.nombre || 'Desconocido'}<br>
                                <small>${playlist.usuarios?.email || 'N/A'}</small>
                            </td>
                            <td style="color: rgba(255,255,255,0.7);">
                                üë• ${(playlist.followers || 0).toLocaleString()}
                            </td>
                            <td>
                                <span class="badge ${estadoClass}">${estadoBadge}</span>
                            </td>
                            <td style="color: rgba(255,255,255,0.7);">${fecha}</td>
                            <td>
                                ${playlist.url_spotify ? `<a href="${playlist.url_spotify}" target="_blank" class="btn-action btn-view">üéµ Ver</a>` : ''}
                                <button class="btn-action btn-delete" onclick="eliminarPlaylistAdmin('${playlist.id}', '${playlist.nombre}')">üóëÔ∏è Eliminar</button>
                            </td>
                        </tr>
                    `;
                });
                
                console.log('‚úÖ Playlists cargadas:', playlists.length);
                
            } catch (err) {
                console.error('‚ùå Error:', err);
                document.getElementById('tablaTodasPlaylists').innerHTML = `
                    <tr><td colspan="6" style="text-align: center; padding: 2rem; color: #ef4444;">Error al cargar playlists</td></tr>
                `;
            }
        }

        // ========================================
        // FILTRAR PLAYLISTS POR ESTADO
        // ========================================
        function filtrarPlaylistsPorEstado(estado) {
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            const rows = document.querySelectorAll('#tablaTodasPlaylists tr[data-estado]');
            
            rows.forEach(row => {
                if (estado === 'todas') {
                    row.style.display = '';
                } else {
                    row.style.display = row.dataset.estado === estado ? '' : 'none';
                }
            });
        }

        // ========================================
        // ELIMINAR PLAYLIST (ADMIN)
        // ========================================
        async function eliminarPlaylistAdmin(playlistId, nombre) {
            if (!confirm(`¬øEliminar playlist "${nombre}"?\n\n‚ö†Ô∏è Esta acci√≥n no se puede deshacer.`)) {
                return;
            }
            
            try {
                const { error } = await supabaseClient
                    .from('playlists')
                    .delete()
                    .eq('id', playlistId);
                
                if (error) throw error;
                
                alert('‚úÖ Playlist eliminada correctamente');
                await cargarTodasPlaylists();
                await cargarPlaylistsPendientes(); // Actualizar contador
                
            } catch (err) {
                console.error('Error:', err);
                alert('‚ùå Error al eliminar playlist');
            }
        }

        // ========================================
        // CARGAR TRANSACCIONES
        // ========================================
        async function cargarTransacciones() {
            try {
                console.log('üîÑ Cargando transacciones...');
                
                // Primero obtenemos las transacciones sin relaciones
                const { data: transacciones, error } = await supabaseClient
                    .from('transacciones')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) {
                    console.error('‚ùå Error:', error);
                    throw error;
                }

                console.log('üìä Transacciones obtenidas:', transacciones);
                
                const tbody = document.getElementById('tablaTransacciones');
                
                if (!transacciones || transacciones.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 2rem; color: rgba(255,255,255,0.5);">No hay transacciones registradas</td></tr>';
                    return;
                }
                
                // Obtener IDs √∫nicos de usuarios para buscar sus datos
                const usuarioIds = [...new Set(transacciones.map(t => t.usuario_id).filter(Boolean))];
                
                // Buscar datos de usuarios
                let usuariosMap = {};
                if (usuarioIds.length > 0) {
                    const { data: usuarios } = await supabaseClient
                        .from('usuarios')
                        .select('id, nombre, email')
                        .in('id', usuarioIds);
                    
                    if (usuarios) {
                        usuarios.forEach(u => {
                            usuariosMap[u.id] = u;
                        });
                    }
                }
                
                tbody.innerHTML = '';
                
                transacciones.forEach(trans => {
                    let estadoBadge = '';
                    let estadoClass = '';
                    
                    const estado = (trans.estado || '').toLowerCase();
                    
                    if (estado === 'completado' || estado === 'completada') {
                        estadoBadge = '‚úÖ Completado';
                        estadoClass = 'badge-aprobada';
                    } else if (estado === 'pendiente') {
                        estadoBadge = '‚è≥ Pendiente';
                        estadoClass = 'badge-pendiente';
                    } else if (estado === 'cancelado' || estado === 'cancelada') {
                        estadoBadge = '‚ùå Cancelado';
                        estadoClass = 'badge';
                    } else {
                        estadoBadge = estado || 'N/A';
                        estadoClass = 'badge';
                    }
                    
                    const fecha = trans.created_at ? new Date(trans.created_at).toLocaleDateString('es-ES') : 'N/A';
                    const usuario = usuariosMap[trans.usuario_id] || {};
                    
                    tbody.innerHTML += `
                        <tr data-estado="${estado}">
                            <td>
                                <strong>${usuario.nombre || trans.usuario_nombre || 'Desconocido'}</strong><br>
                                <small style="color: rgba(255,255,255,0.6);">${usuario.email || trans.usuario_email || 'N/A'}</small>
                            </td>
                            <td style="color: rgba(255,255,255,0.7);">
                                ${trans.tipo || trans.concepto || 'N/A'}
                            </td>
                            <td>
                                <strong style="color: #10b981;">${trans.monto || trans.cantidad || 0}‚Ç¨</strong>
                            </td>
                            <td>
                                <span class="badge ${estadoClass}">${estadoBadge}</span>
                            </td>
                            <td style="color: rgba(255,255,255,0.7);">${fecha}</td>
                        </tr>
                    `;
                });
                
                console.log('‚úÖ Transacciones cargadas:', transacciones.length);
                
            } catch (err) {
                console.error('‚ùå Error:', err);
                document.getElementById('tablaTransacciones').innerHTML = `
                    <tr><td colspan="5" style="text-align: center; padding: 2rem; color: #ef4444;">Error al cargar transacciones: ${err.message}</td></tr>
                `;
            }
        }

        // ========================================
        // FILTRAR TRANSACCIONES POR ESTADO
        // ========================================
        function filtrarTransaccionesPorEstado(estado) {
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            const rows = document.querySelectorAll('#tablaTransacciones tr[data-estado]');
            
            rows.forEach(row => {
                if (estado === 'todos') {
                    row.style.display = '';
                } else {
                    row.style.display = row.dataset.estado === estado ? '' : 'none';
                }
            });
        }

        // ========================================
        // CARGAR TODOS LOS ENV√çOS (desde envios_canciones)
        // ========================================
        async function cargarTodosEnvios() {
            try {
                console.log('üîÑ Cargando env√≠os desde envios_canciones...');
                
                // LEER DE envios_canciones QUE ES DONDE EST√ÅN LOS DATOS REALES
                const { data: envios, error } = await supabaseClient
                    .from('envios_canciones')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) {
                    console.error('‚ùå Error:', error);
                    throw error;
                }

                console.log('üìä Env√≠os obtenidos:', envios);
                
                const tbody = document.getElementById('tablaEnvios');
                
                if (!envios || envios.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 2rem; color: rgba(255,255,255,0.5);">No hay env√≠os registrados</td></tr>';
                    return;
                }
                
                // Obtener IDs √∫nicos para buscar nombres
                const artistaIds = [...new Set(envios.map(e => e.artista_id).filter(Boolean))];
                const curadorIds = [...new Set(envios.map(e => e.curador_id).filter(Boolean))];
                const playlistIds = [...new Set(envios.map(e => e.playlist_id).filter(Boolean))];
                
                // Buscar datos de artistas y curadores
                let usuariosMap = {};
                const allUserIds = [...new Set([...artistaIds, ...curadorIds])];
                if (allUserIds.length > 0) {
                    const { data: usuarios } = await supabaseClient
                        .from('usuarios')
                        .select('id, nombre, email')
                        .in('id', allUserIds);
                    
                    if (usuarios) {
                        usuarios.forEach(u => {
                            usuariosMap[u.id] = u;
                        });
                    }
                }
                
                // Buscar nombres de playlists
                let playlistsMap = {};
                if (playlistIds.length > 0) {
                    const { data: playlists } = await supabaseClient
                        .from('playlists')
                        .select('id, nombre')
                        .in('id', playlistIds);
                    
                    if (playlists) {
                        playlists.forEach(p => {
                            playlistsMap[p.id] = p;
                        });
                    }
                }
                
                tbody.innerHTML = '';
                
                envios.forEach(envio => {
                    let estadoBadge = '';
                    let estadoClass = '';
                    
                    const estado = (envio.estado || '').toLowerCase();
                    
                    if (estado === 'aceptado' || estado === 'aceptado') {
                        estadoBadge = '‚úÖ Aceptado';
                        estadoClass = 'badge-aprobada';
                    } else if (estado === 'pendiente') {
                        estadoBadge = '‚è≥ Pendiente';
                        estadoClass = 'badge-pendiente';
                    } else if (estado === 'rechazado') {
                        estadoBadge = '‚ùå Rechazado';
                        estadoClass = 'badge';
                    } else {
                        estadoBadge = estado || 'N/A';
                        estadoClass = 'badge';
                    }
                    
                    // Usar fecha_envio que es el campo correcto en envios_canciones
                    const fecha = envio.fecha_envio ? new Date(envio.fecha_envio).toLocaleDateString('es-ES') : 
                                  envio.created_at ? new Date(envio.created_at).toLocaleDateString('es-ES') : 'N/A';
                    
                    const artista = usuariosMap[envio.artista_id] || {};
                    const curador = usuariosMap[envio.curador_id] || {};
                    const playlist = playlistsMap[envio.playlist_id] || {};
                    
                    // Campos de envios_canciones
                    const nombreCancion = envio.cancion_nombre || 'Sin nombre';
                    const urlCancion = envio.cancion_url || '';
                    const nombreArtista = envio.artista_nombre || artista.nombre || 'Desconocido';
                    const tipoEnvio = envio.tipo_envio || 'N/A';
                    const creditosUsados = envio.creditos_usados || 0;
                    
                    // Detectar si hay reporte (mensaje_artista empieza con [REPORTE])
                    const tieneReporte = envio.mensaje_artista && envio.mensaje_artista.startsWith('[REPORTE]');
                    
                    tbody.innerHTML += `
                        <tr data-estado="${estado}">
                            <td>
                                <strong>${nombreArtista}</strong><br>
                                <small style="color: rgba(255,255,255,0.6);">${artista.email || 'N/A'}</small>
                            </td>
                            <td>
                                ${nombreCancion}<br>
                                ${urlCancion ? `<a href="${urlCancion}" target="_blank" style="color: #1db954; font-size: 0.85rem;">üéµ Spotify</a>` : ''}
                                ${tieneReporte ? `<br><span style="color: #ef4444; font-size: 0.8rem;">‚ö†Ô∏è REPORTE</span>` : ''}
                            </td>
                            <td style="color: rgba(255,255,255,0.7);">
                                ${playlist.nombre || 'N/A'}
                            </td>
                            <td style="color: rgba(255,255,255,0.7);">
                                ${curador.nombre || 'N/A'}<br>
                                <small>${curador.email || ''}</small>
                            </td>
                            <td>
                                <span class="badge ${estadoClass}">${estadoBadge}</span><br>
                                <small style="color: rgba(255,255,255,0.5);">${tipoEnvio} | ${creditosUsados}‚Ç¨</small>
                            </td>
                            <td style="color: rgba(255,255,255,0.7);">${fecha}</td>
                        </tr>
                    `;
                });
                
                console.log('‚úÖ Env√≠os cargados:', envios.length);
                
            } catch (err) {
                console.error('‚ùå Error:', err);
                document.getElementById('tablaEnvios').innerHTML = `
                    <tr><td colspan="6" style="text-align: center; padding: 2rem; color: #ef4444;">Error al cargar env√≠os: ${err.message}</td></tr>
                `;
            }
        }

        // ========================================
        // FILTRAR ENV√çOS POR ESTADO
        // ========================================
        function filtrarEnviosPorEstado(estado) {
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            const rows = document.querySelectorAll('#tablaEnvios tr[data-estado]');
            
            rows.forEach(row => {
                if (estado === 'todos') {
                    row.style.display = '';
                } else {
                    row.style.display = row.dataset.estado === estado ? '' : 'none';
                }
            });
        }

        // ========================================
        // CARGAR REPORTES (ESTAD√çSTICAS + REPORTES DE USUARIOS)
        // ========================================
        async function cargarReportes() {
            try {
                console.log('üîÑ Cargando reportes y estad√≠sticas...');
                
                // Calcular estad√≠sticas del mes actual
                const hoy = new Date();
                const inicioMes = new Date(hoy.getFullYear(), hoy.getMonth(), 1);
                
                // Ingresos del mes
                const { data: transacciones } = await supabaseClient
                    .from('transacciones')
                    .select('monto')
                    .eq('estado', 'completado')
                    .gte('created_at', inicioMes.toISOString());
                
                const ingresosMes = transacciones?.reduce((sum, t) => sum + parseFloat(t.monto || 0), 0) || 0;
                document.getElementById('ingresosDelMes').textContent = `${ingresosMes.toFixed(2)}‚Ç¨`;
                
                // Env√≠os del mes (DESDE envios_canciones)
                const { data: envios } = await supabaseClient
                    .from('envios_canciones')
                    .select('id')
                    .gte('created_at', inicioMes.toISOString());
                
                document.getElementById('enviosDelMes').textContent = envios?.length || 0;
                
                // Nuevos usuarios del mes
                const { data: usuarios } = await supabaseClient
                    .from('usuarios')
                    .select('id')
                    .gte('created_at', inicioMes.toISOString());
                
                document.getElementById('nuevosUsuarios').textContent = usuarios?.length || 0;
                
                // Total transacciones
                const { data: todasTrans } = await supabaseClient
                    .from('transacciones')
                    .select('id');
                
                document.getElementById('totalTransacciones').textContent = todasTrans?.length || 0;
                
                // =====================================================
                // CARGAR REPORTES REALES DESDE envios_canciones
                // (donde mensaje_artista contiene [REPORTE])
                // =====================================================
                const { data: reportes, error } = await supabaseClient
                    .from('envios_canciones')
                    .select('*')
                    .like('mensaje_artista', '%[REPORTE]%')
                    .order('created_at', { ascending: false })
                    .limit(20);
                
                if (error) {
                    console.error('‚ùå Error cargando reportes:', error);
                }

                console.log('üìä Reportes obtenidos desde envios_canciones:', reportes);
                
                // Obtener datos de artistas, curadores y playlists
                let usuariosMap = {};
                let playlistsMap = {};
                
                if (reportes && reportes.length > 0) {
                    const artistaIds = [...new Set(reportes.map(r => r.artista_id).filter(Boolean))];
                    const curadorIds = [...new Set(reportes.map(r => r.curador_id).filter(Boolean))];
                    const playlistIds = [...new Set(reportes.map(r => r.playlist_id).filter(Boolean))];
                    const allUserIds = [...new Set([...artistaIds, ...curadorIds])];
                    
                    if (allUserIds.length > 0) {
                        const { data: usuarios } = await supabaseClient
                            .from('usuarios')
                            .select('id, nombre, email')
                            .in('id', allUserIds);
                        
                        if (usuarios) {
                            usuarios.forEach(u => usuariosMap[u.id] = u);
                        }
                    }
                    
                    if (playlistIds.length > 0) {
                        const { data: playlists } = await supabaseClient
                            .from('playlists')
                            .select('id, nombre')
                            .in('id', playlistIds);
                        
                        if (playlists) {
                            playlists.forEach(p => playlistsMap[p.id] = p);
                        }
                    }
                }
                
                const tbody = document.getElementById('tablaReportesUsuarios');
                
                if (!reportes || reportes.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 2rem; color: rgba(255,255,255,0.5);">No hay reportes de usuarios</td></tr>';
                } else {
                    tbody.innerHTML = '';
                    
                    reportes.forEach(reporte => {
                        // Extraer el mensaje del reporte (quitar el prefijo [REPORTE])
                        const mensajeReporte = reporte.mensaje_artista.replace('[REPORTE]', '').trim();
                        
                        const fecha = new Date(reporte.created_at).toLocaleString('es-ES');
                        const artista = usuariosMap[reporte.artista_id] || {};
                        const curador = usuariosMap[reporte.curador_id] || {};
                        const playlist = playlistsMap[reporte.playlist_id] || {};
                        
                        tbody.innerHTML += `
                            <tr>
                                <td>
                                    <strong>${reporte.artista_nombre || artista.nombre || 'Desconocido'}</strong><br>
                                    <small style="color: rgba(255,255,255,0.6);">${artista.email || 'N/A'}</small>
                                </td>
                                <td>
                                    <strong>üéµ ${reporte.cancion_nombre}</strong><br>
                                    <a href="${reporte.cancion_url}" target="_blank" style="color: #1db954; font-size: 0.85rem;">Ver en Spotify</a>
                                </td>
                                <td style="max-width: 300px;">
                                    <strong style="color: #ef4444;">‚ö†Ô∏è ${mensajeReporte}</strong><br>
                                    <small style="color: rgba(255,255,255,0.5);">Playlist: ${playlist.nombre || 'N/A'}</small><br>
                                    <small style="color: rgba(255,255,255,0.5);">Curador: ${curador.nombre || 'N/A'}</small>
                                </td>
                                <td>
                                    <span class="badge badge-pendiente">‚è≥ Pendiente</span>
                                </td>
                                <td style="color: rgba(255,255,255,0.7); font-size: 0.9rem;">${fecha}</td>
                                <td>
                                    <button class="btn-action btn-view" onclick="verDetalleReporte(${reporte.id})">üëÅÔ∏è Ver</button>
                                    <button class="btn-action btn-approve" onclick="marcarReporteRevisado(${reporte.id})">‚úÖ Revisar</button>
                                </td>
                            </tr>
                        `;
                    });
                }
                
                console.log('‚úÖ Reportes cargados');
                
            } catch (err) {
                console.error('‚ùå Error:', err);
            }
        }

        // ========================================
        // VER DETALLE DE REPORTE
        // ========================================
        function verDetalleReporte(envioId) {
            alert(`Ver detalle del env√≠o reportado #${envioId}\n\nEsta funci√≥n mostrar√° todos los detalles del env√≠o y permitir√° tomar acciones.`);
        }

        // ========================================
        // FILTRAR REPORTES POR ESTADO
        // ========================================
        function filtrarReportesPorEstado(estado) {
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            const rows = document.querySelectorAll('#tablaReportes tr[data-estado]');
            
            rows.forEach(row => {
                if (estado === 'todos') {
                    row.style.display = '';
                } else {
                    row.style.display = row.dataset.estado === estado ? '' : 'none';
                }
            });
        }

        // ========================================
        // MARCAR REPORTE COMO REVISADO
        // ========================================
        async function marcarReporteRevisado(envioId) {
            if (!confirm('¬øMarcar este reporte como revisado?\n\nEsto a√±adir√° [REVISADO] al mensaje.')) {
                return;
            }
            
            try {
                // Obtener el mensaje actual
                const { data: envio, error: fetchError } = await supabaseClient
                    .from('envios_canciones')
                    .select('mensaje_artista')
                    .eq('id', envioId)
                    .single();
                
                if (fetchError) throw fetchError;
                
                // Actualizar el mensaje a√±adiendo [REVISADO]
                const nuevoMensaje = envio.mensaje_artista.replace('[REPORTE]', '[REPORTE][REVISADO]');
                
                const { error } = await supabaseClient
                    .from('envios_canciones')
                    .update({ mensaje_artista: nuevoMensaje })
                    .eq('id', envioId);
                
                if (error) throw error;
                
                alert('‚úÖ Reporte marcado como revisado');
                await cargarReportes();
                
            } catch (err) {
                console.error('Error:', err);
                alert('‚ùå Error al actualizar reporte');
            }
        }

        // ========================================
        // VARIABLES GLOBALES PARA VERIFICACI√ìN
        // ========================================
        let currentVerifyPlaylistId = null;

        // ========================================
        // VERIFICAR PLAYLIST CON MODAL
        // ========================================
        function verificarPlaylist(playlistId, spotifyId) {
            if (!spotifyId) {
                alert('‚ö†Ô∏è Esta playlist no tiene ID de Spotify');
                return;
            }
            
            // Guardar el ID para usar despu√©s
            currentVerifyPlaylistId = playlistId;
            
            // Abrir Spotify en nueva pesta√±a
            window.open(`https://open.spotify.com/playlist/${spotifyId}`, '_blank');
            
            // Mostrar modal
            document.getElementById('verifyModal').classList.add('active');
            document.getElementById('verifyFollowers').value = '';
            document.getElementById('verifyName').value = '';
            setTimeout(() => document.getElementById('verifyFollowers').focus(), 100);
        }

        // ========================================
        // CERRAR MODAL DE VERIFICACI√ìN
        // ========================================
        function closeVerifyModal() {
            document.getElementById('verifyModal').classList.remove('active');
            currentVerifyPlaylistId = null;
        }

        // ========================================
        // ENVIAR VERIFICACI√ìN
        // ========================================
        function submitVerification() {
            const followers = document.getElementById('verifyFollowers').value.trim();
            const name = document.getElementById('verifyName').value.trim();
            
            if (!followers || isNaN(followers) || parseInt(followers) < 0) {
                alert('‚ö†Ô∏è Debes introducir un n√∫mero v√°lido de seguidores');
                return;
            }
            
            if (!name) {
                alert('‚ö†Ô∏è Debes introducir el nombre de la playlist');
                return;
            }
            
            // Mostrar datos verificados
            document.getElementById(`spotifyData-${currentVerifyPlaylistId}`).innerHTML = `
                <div class="spotify-data">
                    <h4>‚úÖ Datos Verificados</h4>
                    <div class="data-grid">
                        <div class="data-item">
                            <div class="data-label">Nombre:</div>
                            <div class="data-value">${name}</div>
                        </div>
                        <div class="data-item">
                            <div class="data-label">Seguidores:</div>
                            <div class="data-value">${parseInt(followers).toLocaleString()}</div>
                        </div>
                    </div>
                    <div style="margin-top: 1rem; padding: 0.75rem; background: rgba(59, 130, 246, 0.1); border-radius: 0.5rem; color: rgba(255,255,255,0.8); font-size: 0.9rem;">
                        üí° Verificado manualmente por el administrador
                    </div>
                </div>
            `;
            
            // Habilitar bot√≥n aprobar
            const btn = document.getElementById(`btnAprobar-${currentVerifyPlaylistId}`);
            btn.disabled = false;
            btn.dataset.followers = followers;
            btn.dataset.name = name;
            btn.dataset.image = '';
            
            console.log('‚úÖ Datos verificados manualmente');
            
            // Cerrar modal
            closeVerifyModal();
        }

        // Cerrar modal con ESC
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && document.getElementById('verifyModal').classList.contains('active')) {
                closeVerifyModal();
            }
        });

        // ========================================
        // APROBAR PLAYLIST
        // ========================================
        async function aprobarPlaylist(playlistId) {
            const btn = document.getElementById(`btnAprobar-${playlistId}`);
            const followers = btn.dataset.followers;
            const name = btn.dataset.name;
            const image = btn.dataset.image;
            
            if (!followers || !name) {
                alert('‚ö†Ô∏è Primero verifica la playlist');
                return;
            }
            
            if (!confirm(`¬øAprobar esta playlist?\n\nNombre: ${name}\nSeguidores: ${followers}`)) {
                return;
            }
            
            try {
                const { error } = await supabaseClient
                    .from('playlists')
                    .update({
                        estado: 'aprobada',
                        followers: parseInt(followers),
                        nombre: name,
                        imagen_url: image,
                        ultima_actualizacion: new Date().toISOString()
                    })
                    .eq('id', playlistId);
                
                if (error) throw error;
                
                alert('‚úÖ Playlist aprobada correctamente');
                cargarPlaylistsPendientes();
                
            } catch (err) {
                console.error('‚ùå Error:', err);
                alert('‚ùå Error: ' + err.message);
            }
        }

        // ========================================
        // RECHAZAR PLAYLIST
        // ========================================
        async function rechazarPlaylist(playlistId) {
            const motivo = prompt('Motivo del rechazo:\n\nEjemplos:\n- La playlist no te pertenece\n- Datos incorrectos\n- Contenido inapropiado');
            
            if (!motivo || motivo.trim() === '') {
                alert('‚ö†Ô∏è Debes proporcionar un motivo');
                return;
            }
            
            if (!confirm(`¬øRechazar esta playlist?\n\nMotivo: ${motivo}`)) {
                return;
            }
            
            try {
                const { error } = await supabaseClient
                    .from('playlists')
                    .update({
                        estado: 'rechazada',
                        motivo_rechazo: motivo.trim()
                    })
                    .eq('id', playlistId);
                
                if (error) throw error;
                
                alert('‚ùå Playlist rechazada');
                cargarPlaylistsPendientes();
                
            } catch (err) {
                console.error('‚ùå Error:', err);
                alert('‚ùå Error: ' + err.message);
            }
        }

        // Filtrar usuarios
        function filtrarUsuarios() {
            const searchTerm = document.getElementById('searchUsuarios').value.toLowerCase();
            const rows = document.querySelectorAll('#tablaUsuarios tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }

        // Filtrar por tipo
        function filtrarPorTipo(tipo) {
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            const rows = document.querySelectorAll('#tablaUsuarios tr');
            rows.forEach(row => {
                if (tipo === 'todos') {
                    row.style.display = '';
                } else {
                    const badge = row.querySelector('.badge');
                    if (badge) {
                        const rowTipo = badge.textContent.toLowerCase().includes(tipo);
                        row.style.display = rowTipo ? '' : 'none';
                    }
                }
            });
        }

        // Ver usuario
        async function verUsuario(userId, email) {
            try {
                const { data: usuario, error } = await supabaseClient
                    .from('usuarios')
                    .select('*')
                    .eq('id', userId)
                    .single();
                
                if (error) throw error;
                
                const info = `
üìß Email: ${usuario.email}
üë§ Nombre: ${usuario.nombre}
üé≠ Tipo: ${usuario.tipo}
üí∞ Cr√©ditos: ${usuario.creditos}
üíµ Balance: ‚Ç¨${usuario.balance}
üîó C√≥digo Referido: ${usuario.codigo_referido}
üìÖ Registrado: ${new Date(usuario.created_at).toLocaleString('es-ES')}
                `;
                
                alert(info);
            } catch (err) {
                console.error('Error:', err);
                alert('Error al cargar datos del usuario');
            }
        }

        // Ver playlists de un curador
        async function verPlaylistsCurador(curadorId, curadorNombre) {
            try {
                const { data: playlists, error } = await supabaseClient
                    .from('playlists')
                    .select('*')
                    .eq('curador_id', curadorId)
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                if (!playlists || playlists.length === 0) {
                    alert(`üìã PLAYLISTS DE ${curadorNombre.toUpperCase()}\n\nEste curador no tiene playlists registradas.`);
                    return;
                }
                
                let info = `üìã PLAYLISTS DE ${curadorNombre.toUpperCase()}\n`;
                info += `Total: ${playlists.length} playlists\n`;
                info += `${'‚îÄ'.repeat(40)}\n\n`;
                
                playlists.forEach((p, i) => {
                    const estado = p.estado === 'aprobada' ? '‚úÖ' : p.estado === 'pendiente' ? '‚è≥' : '‚ùå';
                    const destacada = p.destacada ? '‚≠ê' : '';
                    info += `${i+1}. ${estado} ${p.nombre} ${destacada}\n`;
                    info += `   üë• ${p.seguidores || p.followers || 0} seguidores\n`;
                    info += `   üìÖ ${new Date(p.created_at).toLocaleDateString('es-ES')}\n\n`;
                });
                
                alert(info);
            } catch (err) {
                console.error('Error:', err);
                alert('Error al cargar playlists del curador');
            }
        }

        // Eliminar usuario
        async function eliminarUsuario(userId, email) {
            if (!confirm(`¬øEliminar usuario ${email}?\n\n‚ö†Ô∏è Esta acci√≥n no se puede deshacer.`)) {
                return;
            }
            
            try {
                const { error } = await supabaseClient
                    .from('usuarios')
                    .delete()
                    .eq('id', userId);
                
                if (error) throw error;
                
                alert('‚úÖ Usuario eliminado correctamente');
                await cargarUsuariosReales();
            } catch (err) {
                console.error('Error:', err);
                alert('‚ùå Error al eliminar usuario');
            }
        }

        // Guardar precios
        function guardarPrecios() {
            const standard = document.getElementById('precioStandard').value;
            const premium = document.getElementById('precioPremium').value;
            alert(`‚úÖ Precios actualizados:\n\nStandard: ${standard}‚Ç¨\nPremium: ${premium}‚Ç¨`);
        }

        // Guardar comisiones
        function guardarComisiones() {
            const plataforma = document.getElementById('comisionPlataforma').value;
            const referidos = document.getElementById('comisionReferidos').value;
            alert(`‚úÖ Comisiones actualizadas:\n\nPlataforma: ${plataforma}%\nReferidos: ${referidos}%`);
        }

        // Limpiar cach√©
        function limpiarCache() {
            if (confirm('¬øLimpiar cach√©?')) {
                alert('‚úÖ Cach√© limpiado');
            }
        }

        // Resetear datos
        function resetearDatos() {
            if (confirm('‚ö†Ô∏è ¬øResetear todos los datos demo?')) {
                alert('‚úÖ Datos reseteados');
            }
        }

        // Exportar reporte
        function exportarReporte() {
            alert('üì• Exportando reporte CSV...');
        }

        // ========================================
        // RESEND API KEY
        // ========================================
        const RESEND_API_KEY = 're_g2hvkESD_6BqXWQeh53P7Auh1iMWk9aMU';

        // ========================================
        // CARGAR AFILIADOS
        // ========================================
        async function cargarAfiliados() {
            try {
                console.log('üîÑ Cargando afiliados...');
                
                const { data: afiliados, error } = await supabaseClient
                    .from('solicitudes_afiliados')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                const tbody = document.getElementById('tablaAfiliados');
                
                if (!afiliados || afiliados.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 2rem; color: rgba(255,255,255,0.5);">No hay solicitudes de afiliados</td></tr>';
                    document.getElementById('afiliadosPendientes').textContent = '0';
                    return;
                }
                
                // Actualizar contador de pendientes
                const pendientes = afiliados.filter(a => {
                    const est = (a.estado || '').toLowerCase().trim();
                    return est !== 'aceptado' && est !== 'rechazado';
                }).length;
                document.getElementById('afiliadosPendientes').textContent = pendientes;
                
                tbody.innerHTML = afiliados.map(afiliado => {
                    const fecha = new Date(afiliado.created_at).toLocaleDateString('es-ES');
                    const estado = (afiliado.estado || 'pendiente').toLowerCase().trim();
                    
                    console.log('Afiliado:', afiliado.nombre, 'Estado:', estado, 'Original:', afiliado.estado);
                    
                    const estadoBadge = estado === 'aceptado' 
                        ? '<span class="badge badge-aprobada">‚úÖ Aprobado</span>'
                        : estado === 'rechazado'
                        ? '<span class="badge" style="background: rgba(239,68,68,0.2); color: #ef4444;">‚ùå Rechazado</span>'
                        : '<span class="badge badge-pendiente">‚è≥ Pendiente</span>';
                    
                    const link = `https://algoritmoenmovimiento.com/?ref=${afiliado.codigo_afiliado}`;
                    
                    // Mostrar botones si NO est√° aprobado ni rechazado
                    const acciones = (estado !== 'aceptado' && estado !== 'rechazado')
                        ? `<button class="btn-action btn-approve" onclick="aprobarAfiliado('${afiliado.id}', '${afiliado.email}', '${afiliado.nombre}', '${afiliado.codigo_afiliado}')">‚úÖ Aprobar</button>
                           <button class="btn-action btn-reject" onclick="rechazarAfiliado('${afiliado.id}')">‚ùå Rechazar</button>`
                        : estado === 'aceptado'
                        ? `<button class="btn-action btn-view" onclick="copiarLink('${link}')">üìã Copiar Link</button>`
                        : '-';
                    
                    return `
                        <tr data-estado="${estado}">
                            <td>${afiliado.nombre}</td>
                            <td style="color: rgba(255,255,255,0.7);">${afiliado.email}</td>
                            <td>${afiliado.instagram || '-'}</td>
                            <td><code style="background: rgba(255,255,255,0.1); padding: 0.3rem 0.6rem; border-radius: 4px;">${afiliado.codigo_afiliado}</code></td>
                            <td>${estadoBadge}</td>
                            <td style="color: rgba(255,255,255,0.7);">${fecha}</td>
                            <td>${acciones}</td>
                        </tr>
                    `;
                }).join('');
                
            } catch (err) {
                console.error('‚ùå Error cargando afiliados:', err);
            }
        }

        // Filtrar afiliados
        function filtrarAfiliados(estado) {
            document.querySelectorAll('#tabAfiliados .filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            const rows = document.querySelectorAll('#tablaAfiliados tr');
            rows.forEach(row => {
                if (estado === 'todos') {
                    row.style.display = '';
                } else {
                    row.style.display = row.dataset.estado === estado ? '' : 'none';
                }
            });
        }

        // Copiar link de afiliado
        function copiarLink(link) {
            navigator.clipboard.writeText(link).then(() => {
                alert('‚úÖ Link copiado al portapapeles:\n\n' + link);
            });
        }

        // Aprobar afiliado y enviar email
        async function aprobarAfiliado(id, email, nombre, codigo) {
            if (!confirm(`¬øAprobar a ${nombre} como afiliado?\n\nSe enviar√° un email autom√°tico con su link personalizado.`)) {
                return;
            }
            
            console.log('üîÑ Aprobando afiliado:', { id, email, nombre, codigo });
            
            try {
                // Actualizar estado en Supabase
                const { data, error } = await supabaseClient
                    .from('solicitudes_afiliados')
                    .update({ 
                        estado: 'aceptado',
                        notificado: true 
                    })
                    .eq('id', id)
                    .select();
                
                console.log('üìù Resultado update:', { data, error });
                
                if (error) {
                    console.error('‚ùå Error Supabase:', error);
                    throw error;
                }
                
                if (!data || data.length === 0) {
                    console.error('‚ö†Ô∏è No se actualiz√≥ ning√∫n registro');
                    alert('‚ö†Ô∏è Error: No se encontr√≥ el afiliado o no tienes permisos para actualizarlo.\n\nRevisa las pol√≠ticas RLS en Supabase.');
                    return;
                }
                
                console.log('‚úÖ Estado actualizado correctamente:', data);
                
                // Enviar email con Resend
                const link = `https://algoritmoenmovimiento.com/?ref=${codigo}`;
                
                try {
                    await enviarEmailAfiliado(email, nombre, codigo, link);
                    alert('‚úÖ Afiliado aprobado y email enviado correctamente');
                } catch (emailErr) {
                    console.error('Error email:', emailErr);
                    alert('‚ö†Ô∏è Afiliado aprobado pero hubo un error enviando el email.\n\nLink para enviar manualmente:\n' + link);
                }
                
                cargarAfiliados();
                
            } catch (err) {
                console.error('‚ùå Error completo:', err);
                alert('‚ùå Error: ' + (err.message || JSON.stringify(err)));
            }
        }

        // Enviar email con Resend (a trav√©s de API serverless)
        async function enviarEmailAfiliado(email, nombre, codigo, link) {
            try {
                const response = await fetch('https://algoritmo-admin.vercel.app/api/send-email', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: email,
                        nombre: nombre,
                        codigo: codigo,
                        link: link
                    })
                });
                
                const data = await response.json();
                console.log('üìß Respuesta API:', data);
                
                if (!response.ok) {
                    throw new Error(data.error || 'Error enviando email');
                }
                
                return true;
                
            } catch (err) {
                console.error('‚ùå Error enviando email:', err);
                throw err;
            }
        }

        // Rechazar afiliado
        async function rechazarAfiliado(id) {
            const motivo = prompt('Motivo del rechazo (opcional):');
            
            if (!confirm('¬øRechazar esta solicitud de afiliado?')) {
                return;
            }
            
            try {
                const { error } = await supabaseClient
                    .from('solicitudes_afiliados')
                    .update({ 
                        estado: 'rechazado',
                        motivo_rechazo: motivo || null
                    })
                    .eq('id', id);
                
                if (error) throw error;
                
                alert('‚ùå Solicitud rechazada');
                cargarAfiliados();
                
            } catch (err) {
                console.error('‚ùå Error:', err);
                alert('‚ùå Error: ' + err.message);
            }
        }

        // ========================================
        // CARGAR COMISIONES DE AFILIADOS
        // ========================================
        async function cargarComisionesAfiliados() {
            try {
                console.log('üîÑ Cargando comisiones...');
                
                const { data: comisiones, error } = await supabaseClient
                    .from('comisiones_afiliados')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                const tbody = document.getElementById('tablaComisiones');
                
                if (!comisiones || comisiones.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 2rem; color: rgba(255,255,255,0.5);">No hay comisiones registradas</td></tr>';
                    document.getElementById('totalComisiones').textContent = '‚Ç¨0';
                    document.getElementById('comisionesPendientesTotal').textContent = '‚Ç¨0';
                    document.getElementById('comisionesPagadas').textContent = '‚Ç¨0';
                    return;
                }
                
                // Calcular totales
                const total = comisiones.reduce((sum, c) => sum + parseFloat(c.comision), 0);
                const pendientes = comisiones.filter(c => c.estado === 'pendiente' || c.estado === 'confirmado').reduce((sum, c) => sum + parseFloat(c.comision), 0);
                const pagadas = comisiones.filter(c => c.estado === 'pagado').reduce((sum, c) => sum + parseFloat(c.comision), 0);
                
                document.getElementById('totalComisiones').textContent = '‚Ç¨' + total.toFixed(2);
                document.getElementById('comisionesPendientesTotal').textContent = '‚Ç¨' + pendientes.toFixed(2);
                document.getElementById('comisionesPagadas').textContent = '‚Ç¨' + pagadas.toFixed(2);
                
                tbody.innerHTML = comisiones.map(comision => {
                    const fecha = new Date(comision.created_at).toLocaleDateString('es-ES');
                    const estadoBadge = comision.estado === 'pagado' 
                        ? '<span class="badge badge-aprobada">üí∞ Pagado</span>'
                        : comision.estado === 'confirmado'
                        ? '<span class="badge" style="background: rgba(59,130,246,0.2); color: #3b82f6;">‚úÖ Confirmado</span>'
                        : '<span class="badge badge-pendiente">‚è≥ Pendiente</span>';
                    
                    const acciones = comision.estado !== 'pagado'
                        ? `<button class="btn-action btn-approve" onclick="marcarComisionPagada('${comision.id}')">üí∞ Marcar Pagada</button>`
                        : '-';
                    
                    return `
                        <tr data-estado="${comision.estado}">
                            <td><code>${comision.codigo_afiliado}</code></td>
                            <td style="color: rgba(255,255,255,0.7);">${comision.usuario_comprador_id?.substring(0, 8) || 'N/A'}...</td>
                            <td>${comision.tipo_compra}</td>
                            <td>‚Ç¨${parseFloat(comision.monto_compra).toFixed(2)}</td>
                            <td style="color: #10b981; font-weight: bold;">‚Ç¨${parseFloat(comision.comision).toFixed(2)}</td>
                            <td>${estadoBadge}</td>
                            <td style="color: rgba(255,255,255,0.7);">${fecha}</td>
                            <td>${acciones}</td>
                        </tr>
                    `;
                }).join('');
                
            } catch (err) {
                console.error('‚ùå Error cargando comisiones:', err);
            }
        }

        // Filtrar comisiones
        function filtrarComisiones(estado) {
            document.querySelectorAll('#tabComisionesAfiliados .filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            const rows = document.querySelectorAll('#tablaComisiones tr');
            rows.forEach(row => {
                if (estado === 'todos') {
                    row.style.display = '';
                } else {
                    row.style.display = row.dataset.estado === estado ? '' : 'none';
                }
            });
        }

        // Marcar comisi√≥n como pagada
        async function marcarComisionPagada(id) {
            if (!confirm('¬øMarcar esta comisi√≥n como pagada?')) return;
            
            try {
                const { error } = await supabaseClient
                    .from('comisiones_afiliados')
                    .update({ 
                        estado: 'pagado',
                        pagado_at: new Date().toISOString()
                    })
                    .eq('id', id);
                
                if (error) throw error;
                
                alert('‚úÖ Comisi√≥n marcada como pagada');
                cargarComisionesAfiliados();
                
            } catch (err) {
                console.error('‚ùå Error:', err);
                alert('‚ùå Error: ' + err.message);
            }
        }

        // ========================================
        // CARGAR RETIROS
        // ========================================
        async function cargarRetiros() {
            try {
                console.log('üîÑ Cargando retiros...');
                
                const { data: retiros, error } = await supabaseClient
                    .from('solicitudes_retiro')
                    .select(`
                        *,
                        usuarios (nombre, email, tipo)
                    `)
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                const tbody = document.getElementById('tablaRetiros');
                
                if (!retiros || retiros.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 2rem; color: rgba(255,255,255,0.5);">No hay solicitudes de retiro</td></tr>';
                    document.getElementById('retirosPendientes').textContent = '0';
                    document.getElementById('totalRetirosPendientes').textContent = '‚Ç¨0';
                    document.getElementById('totalRetirosCompletados').textContent = '‚Ç¨0';
                    return;
                }
                
                // Calcular totales
                const pendientes = retiros.filter(r => r.estado === 'pendiente');
                const completados = retiros.filter(r => r.estado === 'completado');
                
                document.getElementById('retirosPendientes').textContent = pendientes.length;
                document.getElementById('totalRetirosPendientes').textContent = '‚Ç¨' + pendientes.reduce((sum, r) => sum + parseFloat(r.monto), 0).toFixed(2);
                document.getElementById('totalRetirosCompletados').textContent = '‚Ç¨' + completados.reduce((sum, r) => sum + parseFloat(r.monto), 0).toFixed(2);
                
                tbody.innerHTML = retiros.map(retiro => {
                    const fecha = new Date(retiro.created_at).toLocaleDateString('es-ES');
                    const tipoUsuario = retiro.usuarios?.tipo === 'curador' ? 'üéß Curador' : 'ü§ù Afiliado';
                    
                    const estadoBadge = retiro.estado === 'completado' 
                        ? '<span class="badge badge-aprobada">‚úÖ Completado</span>'
                        : retiro.estado === 'rechazado'
                        ? '<span class="badge" style="background: rgba(239,68,68,0.2); color: #ef4444;">‚ùå Rechazado</span>'
                        : '<span class="badge badge-pendiente">‚è≥ Pendiente</span>';
                    
                    const acciones = retiro.estado === 'pendiente'
                        ? `<button class="btn-action btn-approve" onclick="completarRetiro('${retiro.id}')">‚úÖ Completar</button>
                           <button class="btn-action btn-reject" onclick="rechazarRetiro('${retiro.id}')">‚ùå Rechazar</button>`
                        : '-';
                    
                    return `
                        <tr data-estado="${retiro.estado}">
                            <td>${retiro.usuarios?.nombre || 'N/A'}<br><small style="color: rgba(255,255,255,0.5);">${retiro.usuarios?.email || ''}</small></td>
                            <td>${tipoUsuario}</td>
                            <td style="font-weight: bold; color: #10b981;">‚Ç¨${parseFloat(retiro.monto).toFixed(2)}</td>
                            <td>${retiro.metodo_pago || 'PayPal'}</td>
                            <td style="color: rgba(255,255,255,0.7); font-size: 0.9rem;">${retiro.datos_pago || 'N/A'}</td>
                            <td>${estadoBadge}</td>
                            <td style="color: rgba(255,255,255,0.7);">${fecha}</td>
                            <td>${acciones}</td>
                        </tr>
                    `;
                }).join('');
                
            } catch (err) {
                console.error('‚ùå Error cargando retiros:', err);
                document.getElementById('tablaRetiros').innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 2rem; color: rgba(255,255,255,0.5);">Error al cargar retiros</td></tr>';
            }
        }

        // Filtrar retiros
        function filtrarRetiros(estado) {
            document.querySelectorAll('#tabRetiros .filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            const rows = document.querySelectorAll('#tablaRetiros tr');
            rows.forEach(row => {
                if (estado === 'todos') {
                    row.style.display = '';
                } else {
                    row.style.display = row.dataset.estado === estado ? '' : 'none';
                }
            });
        }

        // Completar retiro
        async function completarRetiro(id) {
            if (!confirm('¬øMarcar este retiro como completado?\n\nAseg√∫rate de haber realizado el pago.')) return;
            
            try {
                const { error } = await supabaseClient
                    .from('solicitudes_retiro')
                    .update({ 
                        estado: 'completado',
                        completado_at: new Date().toISOString()
                    })
                    .eq('id', id);
                
                if (error) throw error;
                
                alert('‚úÖ Retiro marcado como completado');
                cargarRetiros();
                
            } catch (err) {
                console.error('‚ùå Error:', err);
                alert('‚ùå Error: ' + err.message);
            }
        }

        // Rechazar retiro
        async function rechazarRetiro(id) {
            const motivo = prompt('Motivo del rechazo:');
            if (!motivo) {
                alert('‚ö†Ô∏è Debes proporcionar un motivo');
                return;
            }
            
            try {
                const { error } = await supabaseClient
                    .from('solicitudes_retiro')
                    .update({ 
                        estado: 'rechazado',
                        motivo_rechazo: motivo
                    })
                    .eq('id', id);
                
                if (error) throw error;
                
                alert('‚ùå Retiro rechazado');
                cargarRetiros();
                
            } catch (err) {
                console.error('‚ùå Error:', err);
                alert('‚ùå Error: ' + err.message);
            }
        }

        // Verificar sesi√≥n al cargar
        window.addEventListener('load', () => {
            if (sessionStorage.getItem('adminLoggedIn') === 'true') {
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('adminPanel').style.display = 'block';
                cargarUsuariosReales();
                cargarPlaylistsPendientes();
                cargarTodasPlaylists();
                cargarTransacciones();
                cargarTodosEnvios();
                cargarReportes();
                cargarAfiliados();
                cargarRetiros();
                cargarSolicitudesDestacar();
                cargarCanjes();
            }
        });

        // ==================== DESTACAR PLAYLISTS ====================
        
        let todasSolicitudesDestacar = [];
        
        async function cargarSolicitudesDestacar() {
            try {
                const { data, error } = await supabaseClient
                    .from('solicitudes_destacar')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) {
                    console.error('Error cargando solicitudes destacar:', error);
                    document.getElementById('tablaDestacar').innerHTML = `
                        <tr><td colspan="6" style="text-align: center; padding: 2rem; color: rgba(255,255,255,0.5);">
                            Error al cargar o tabla no existe
                        </td></tr>`;
                    return;
                }
                
                todasSolicitudesDestacar = data || [];
                
                // Actualizar contadores
                const pendientes = todasSolicitudesDestacar.filter(s => s.estado === 'pendiente');
                const aprobados = todasSolicitudesDestacar.filter(s => s.estado === 'aprobado');
                
                document.getElementById('destacarPendientes').textContent = pendientes.length;
                document.getElementById('totalDestacarPendientes').textContent = pendientes.length;
                document.getElementById('totalDestacarActivas').textContent = aprobados.length;
                
                // Calcular ingresos del mes
                const inicioMes = new Date();
                inicioMes.setDate(1);
                inicioMes.setHours(0, 0, 0, 0);
                
                const ingresosMes = aprobados
                    .filter(s => new Date(s.aprobado_at) >= inicioMes)
                    .reduce((sum, s) => sum + (s.precio || 14.99), 0);
                
                document.getElementById('ingresoDestacar').textContent = `‚Ç¨${ingresosMes.toFixed(2)}`;
                
                renderizarSolicitudesDestacar(todasSolicitudesDestacar);
                
            } catch (err) {
                console.error('Error:', err);
            }
        }
        
        function renderizarSolicitudesDestacar(solicitudes) {
            const tbody = document.getElementById('tablaDestacar');
            
            if (!solicitudes || solicitudes.length === 0) {
                tbody.innerHTML = `
                    <tr><td colspan="6" style="text-align: center; padding: 2rem; color: rgba(255,255,255,0.5);">
                        No hay solicitudes de destacar
                    </td></tr>`;
                return;
            }
            
            tbody.innerHTML = solicitudes.map(s => {
                const fecha = new Date(s.created_at).toLocaleDateString('es-ES');
                
                let estadoBadge = '';
                let acciones = '';
                
                if (s.estado === 'pendiente') {
                    estadoBadge = '<span style="background: #f59e0b; color: white; padding: 0.25rem 0.75rem; border-radius: 1rem; font-size: 0.8rem;">‚è≥ Pendiente</span>';
                    acciones = `
                        <button onclick="aprobarDestacar('${s.id}', '${s.playlist_id}')" style="background: #10b981; color: white; border: none; padding: 0.5rem 1rem; border-radius: 0.5rem; cursor: pointer; margin-right: 0.5rem;">‚úÖ Aprobar</button>
                        <button onclick="rechazarDestacar('${s.id}')" style="background: #ef4444; color: white; border: none; padding: 0.5rem 1rem; border-radius: 0.5rem; cursor: pointer;">‚ùå Rechazar</button>
                    `;
                } else if (s.estado === 'aprobado') {
                    estadoBadge = '<span style="background: #10b981; color: white; padding: 0.25rem 0.75rem; border-radius: 1rem; font-size: 0.8rem;">‚úÖ Aprobado</span>';
                    acciones = `<button onclick="quitarDestacado('${s.id}', '${s.playlist_id}')" style="background: #6b7280; color: white; border: none; padding: 0.5rem 1rem; border-radius: 0.5rem; cursor: pointer;">üö´ Quitar</button>`;
                } else if (s.estado === 'rechazado') {
                    estadoBadge = '<span style="background: #ef4444; color: white; padding: 0.25rem 0.75rem; border-radius: 1rem; font-size: 0.8rem;">‚ùå Rechazado</span>';
                    acciones = `<span style="color: rgba(255,255,255,0.5); font-size: 0.85rem;">${s.motivo_rechazo || 'Sin motivo'}</span>`;
                }
                
                return `
                    <tr>
                        <td>
                            <div style="font-weight: 600;">${s.curador_nombre || 'Sin nombre'}</div>
                            <div style="font-size: 0.8rem; color: rgba(255,255,255,0.6);">${s.curador_email || ''}</div>
                        </td>
                        <td>
                            <div style="font-weight: 600;">üéµ ${s.playlist_nombre || 'Playlist'}</div>
                        </td>
                        <td style="font-weight: 700; color: #10b981;">‚Ç¨${(s.precio || 14.99).toFixed(2)}/mes</td>
                        <td>${estadoBadge}</td>
                        <td>${fecha}</td>
                        <td>${acciones}</td>
                    </tr>
                `;
            }).join('');
        }
        
        function filtrarDestacar(estado) {
            // Actualizar botones activos
            document.querySelectorAll('#tabDestacar .filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            if (estado === 'todos') {
                renderizarSolicitudesDestacar(todasSolicitudesDestacar);
            } else {
                const filtradas = todasSolicitudesDestacar.filter(s => s.estado === estado);
                renderizarSolicitudesDestacar(filtradas);
            }
        }
        
        async function aprobarDestacar(id, playlistId) {
            if (!confirm('‚úÖ ¬øAprobar esta solicitud?\n\nLa playlist ser√° marcada como DESTACADA y aparecer√° en la secci√≥n TOP.')) {
                return;
            }
            
            try {
                // Actualizar solicitud
                const { error: errorSolicitud } = await supabaseClient
                    .from('solicitudes_destacar')
                    .update({ 
                        estado: 'aprobado',
                        aprobado_at: new Date().toISOString()
                    })
                    .eq('id', id);
                
                if (errorSolicitud) throw errorSolicitud;
                
                // Marcar playlist como destacada
                const { error: errorPlaylist } = await supabaseClient
                    .from('playlists')
                    .update({ destacada: true })
                    .eq('id', playlistId);
                
                if (errorPlaylist) {
                    console.warn('No se pudo actualizar playlist:', errorPlaylist);
                }
                
                alert('‚úÖ Solicitud aprobada\n\nLa playlist ahora est√° destacada.');
                cargarSolicitudesDestacar();
                
            } catch (err) {
                console.error('Error:', err);
                alert('‚ùå Error: ' + err.message);
            }
        }
        
        async function rechazarDestacar(id) {
            const motivo = prompt('Motivo del rechazo:');
            if (!motivo) {
                alert('‚ö†Ô∏è Debes proporcionar un motivo');
                return;
            }
            
            try {
                const { error } = await supabaseClient
                    .from('solicitudes_destacar')
                    .update({ 
                        estado: 'rechazado',
                        motivo_rechazo: motivo
                    })
                    .eq('id', id);
                
                if (error) throw error;
                
                alert('‚ùå Solicitud rechazada');
                cargarSolicitudesDestacar();
                
            } catch (err) {
                console.error('Error:', err);
                alert('‚ùå Error: ' + err.message);
            }
        }
        
        async function quitarDestacado(id, playlistId) {
            if (!confirm('üö´ ¬øQuitar el destacado de esta playlist?\n\nLa playlist dejar√° de aparecer en TOP.')) {
                return;
            }
            
            try {
                // Actualizar solicitud
                const { error: errorSolicitud } = await supabaseClient
                    .from('solicitudes_destacar')
                    .update({ estado: 'cancelado' })
                    .eq('id', id);
                
                if (errorSolicitud) throw errorSolicitud;
                
                // Quitar destacado de playlist
                const { error: errorPlaylist } = await supabaseClient
                    .from('playlists')
                    .update({ destacada: false })
                    .eq('id', playlistId);
                
                if (errorPlaylist) {
                    console.warn('No se pudo actualizar playlist:', errorPlaylist);
                }
                
                alert('üö´ Destacado removido');
                cargarSolicitudesDestacar();
                
            } catch (err) {
                console.error('Error:', err);
                alert('‚ùå Error: ' + err.message);
            }
        }

        // ==================== CANJES DE SERVICIOS ====================
        
        let todosCanjes = [];
        
        const serviciosNombres = {
            'envio_playlist': 'üéµ Env√≠o a Playlists',
            'promo_tiktok': 'üì± Promo TikTok',
            'playlist_top': 'üèÜ Playlist TOP',
            'top_playlist': 'üèÜ Playlist TOP (Puntos)',
            'redes_sociales': 'üì± Promo Redes (Puntos)',
            'mastering_ia': 'üéõÔ∏è Mastering IA'
        };
        
        async function cargarCanjes() {
            try {
                // Cargar de tabla canjes_servicios (pagos con dinero)
                const { data: canjesServicios, error: errorServicios } = await supabaseClient
                    .from('canjes_servicios')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                // Cargar de tabla canjes (pagos con puntos)
                const { data: canjesPuntos, error: errorPuntos } = await supabaseClient
                    .from('canjes')
                    .select(`
                        *,
                        usuarios:curador_id (nombre, email),
                        playlists:playlist_id (nombre, followers)
                    `)
                    .order('created_at', { ascending: false });
                
                let todosLosCanjes = [];
                
                // Procesar canjes de servicios
                if (!errorServicios && canjesServicios) {
                    canjesServicios.forEach(c => {
                        todosLosCanjes.push({
                            ...c,
                            fuente: 'servicios',
                            puntos: c.puntos || 0
                        });
                    });
                }
                
                // Procesar canjes con puntos
                if (!errorPuntos && canjesPuntos) {
                    canjesPuntos.forEach(c => {
                        // Extraer nombre de playlist de notas o del join
                        let playlistNombre = '';
                        if (c.playlists?.nombre) {
                            playlistNombre = c.playlists.nombre;
                        } else if (c.notas) {
                            const match = c.notas.match(/Playlist: ([^|]+)/);
                            if (match) playlistNombre = match[1].trim();
                        }
                        
                        todosLosCanjes.push({
                            id: c.id,
                            curador_id: c.curador_id,
                            curador_nombre: c.usuarios?.nombre || 'Sin nombre',
                            curador_email: c.usuarios?.email || '',
                            tipo: c.tipo,
                            puntos: c.puntos_gastados || 0,
                            estado: c.estado,
                            created_at: c.created_at,
                            completado_at: c.completado_at,
                            fecha_inicio: c.fecha_inicio,
                            fecha_fin: c.fecha_fin,
                            datos_extra: {
                                playlist_nombre: playlistNombre,
                                playlist_id: c.playlist_id,
                                seguidores: c.playlists?.followers || 0
                            },
                            notas: c.notas,
                            fuente: 'puntos'
                        });
                    });
                }
                
                // Ordenar por fecha m√°s reciente
                todosLosCanjes.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                
                todosCanjes = todosLosCanjes;
                
                // Actualizar contadores
                const pendientes = todosCanjes.filter(c => c.estado === 'pendiente');
                const completados = todosCanjes.filter(c => c.estado === 'completado' || c.estado === 'aprobado');
                const totalPuntos = todosCanjes.reduce((sum, c) => sum + (c.puntos || 0), 0);
                
                document.getElementById('canjesPendientes').textContent = pendientes.length;
                document.getElementById('totalCanjesPendientes').textContent = pendientes.length;
                document.getElementById('totalCanjesCompletados').textContent = completados.length;
                document.getElementById('totalPuntosCanjeados').textContent = totalPuntos;
                
                renderizarCanjes(todosCanjes);
                
            } catch (err) {
                console.error('Error:', err);
                document.getElementById('tablaCanjes').innerHTML = `
                    <tr><td colspan="6" style="text-align: center; padding: 2rem; color: rgba(255,255,255,0.5);">
                        Error al cargar canjes
                    </td></tr>`;
            }
        }
        
        function renderizarCanjes(canjes) {
            const tbody = document.getElementById('tablaCanjes');
            
            if (!canjes || canjes.length === 0) {
                tbody.innerHTML = `
                    <tr><td colspan="6" style="text-align: center; padding: 2rem; color: rgba(255,255,255,0.5);">
                        No hay canjes de servicios
                    </td></tr>`;
                return;
            }
            
            tbody.innerHTML = canjes.map(c => {
                const fecha = new Date(c.created_at).toLocaleDateString('es-ES');
                const servicioNombre = serviciosNombres[c.tipo] || c.tipo;
                const datos = c.datos_extra || {};
                
                // Formatear datos extra seg√∫n tipo de servicio
                let detallesExtra = '';
                if (c.tipo === 'promo_tiktok' && datos.link_video) {
                    detallesExtra = `<div style="font-size: 0.75rem; color: #ec4899; margin-top: 0.25rem;">üìπ <a href="${datos.link_video}" target="_blank" style="color: #ec4899;">Ver Video</a></div>`;
                    if (datos.instrucciones) detallesExtra += `<div style="font-size: 0.7rem; color: rgba(255,255,255,0.5);">üìù ${datos.instrucciones}</div>`;
                }
                if (c.tipo === 'mastering_ia' && datos.link_cancion) {
                    detallesExtra = `<div style="font-size: 0.75rem; color: #3b82f6; margin-top: 0.25rem;">üéµ ${datos.nombre_cancion || 'Canci√≥n'}</div>`;
                    detallesExtra += `<div style="font-size: 0.7rem;"><a href="${datos.link_cancion}" target="_blank" style="color: #3b82f6;">‚¨áÔ∏è Descargar</a></div>`;
                }
                if ((c.tipo === 'playlist_top' || c.tipo === 'top_playlist') && datos.playlist_nombre) {
                    detallesExtra = `<div style="font-size: 0.75rem; color: #8b5cf6; margin-top: 0.25rem;">üìã ${datos.playlist_nombre}</div>`;
                    if (datos.seguidores) {
                        detallesExtra += `<div style="font-size: 0.7rem; color: rgba(255,255,255,0.5);">üë• ${datos.seguidores.toLocaleString()} seguidores</div>`;
                    }
                }
                if (c.tipo === 'redes_sociales') {
                    detallesExtra = `<div style="font-size: 0.75rem; color: #ec4899; margin-top: 0.25rem;">üì± Instagram, TikTok, Facebook</div>`;
                }
                
                // Mostrar notas si existen y no se han procesado arriba
                if (c.notas && !detallesExtra) {
                    detallesExtra = `<div style="font-size: 0.7rem; color: rgba(255,255,255,0.5); margin-top: 0.25rem;">üìù ${c.notas.substring(0, 50)}${c.notas.length > 50 ? '...' : ''}</div>`;
                }
                
                // Badge de fuente (puntos o pago)
                const fuenteBadge = c.fuente === 'puntos' 
                    ? '<span style="background: rgba(251,191,36,0.2); color: #fbbf24; padding: 0.15rem 0.5rem; border-radius: 0.25rem; font-size: 0.65rem; margin-left: 0.5rem;">‚≠ê PUNTOS</span>'
                    : '<span style="background: rgba(16,185,129,0.2); color: #10b981; padding: 0.15rem 0.5rem; border-radius: 0.25rem; font-size: 0.65rem; margin-left: 0.5rem;">üí∞ PAGO</span>';
                
                let estadoBadge = '';
                let acciones = '';
                
                if (c.estado === 'pendiente') {
                    estadoBadge = '<span style="background: #f59e0b; color: white; padding: 0.25rem 0.75rem; border-radius: 1rem; font-size: 0.8rem;">‚è≥ Pendiente</span>';
                    acciones = `
                        <button onclick="verDetallesCanje('${c.id}', '${c.fuente || 'servicios'}')" style="background: #6b7280; color: white; border: none; padding: 0.5rem 0.75rem; border-radius: 0.5rem; cursor: pointer; margin-right: 0.25rem;">üëÅÔ∏è</button>
                        <button onclick="aprobarCanje('${c.id}', '${c.fuente || 'servicios'}')" style="background: #10b981; color: white; border: none; padding: 0.5rem 0.75rem; border-radius: 0.5rem; cursor: pointer; margin-right: 0.25rem;">‚úÖ</button>
                        <button onclick="rechazarCanje('${c.id}', '${c.fuente || 'servicios'}')" style="background: #ef4444; color: white; border: none; padding: 0.5rem 0.75rem; border-radius: 0.5rem; cursor: pointer;">‚ùå</button>
                    `;
                } else if (c.estado === 'completado' || c.estado === 'aprobado') {
                    estadoBadge = '<span style="background: #10b981; color: white; padding: 0.25rem 0.75rem; border-radius: 1rem; font-size: 0.8rem;">‚úÖ Aprobado</span>';
                    const fechaCompletado = c.completado_at ? new Date(c.completado_at).toLocaleDateString('es-ES') : '-';
                    acciones = `<span style="color: rgba(255,255,255,0.5); font-size: 0.85rem;">${fechaCompletado}</span>`;
                } else if (c.estado === 'rechazado') {
                    estadoBadge = '<span style="background: #ef4444; color: white; padding: 0.25rem 0.75rem; border-radius: 1rem; font-size: 0.8rem;">‚ùå Rechazado</span>';
                    acciones = `<span style="color: rgba(255,255,255,0.5); font-size: 0.85rem;">-</span>`;
                }
                
                return `
                    <tr>
                        <td>
                            <div style="font-weight: 600;">${c.curador_nombre || 'Sin nombre'}</div>
                            <div style="font-size: 0.8rem; color: rgba(255,255,255,0.6);">${c.curador_email || ''}</div>
                        </td>
                        <td>
                            <div style="font-weight: 600;">${servicioNombre}${fuenteBadge}</div>
                            ${detallesExtra}
                        </td>
                        <td style="font-weight: 700; color: #f472b6;">${c.puntos} pts</td>
                        <td>${estadoBadge}</td>
                        <td>${fecha}</td>
                        <td>${acciones}</td>
                    </tr>
                `;
            }).join('');
        }
        
        function verDetallesCanje(id, fuente) {
            const canje = todosCanjes.find(c => c.id === id);
            if (!canje) return;
            
            const datos = canje.datos_extra || {};
            let detalles = `üì¶ DETALLES DEL CANJE\n\n`;
            detalles += `üë§ Curador: ${canje.curador_nombre}\n`;
            detalles += `üìß Email: ${canje.curador_email}\n`;
            detalles += `üéÅ Servicio: ${serviciosNombres[canje.tipo] || canje.tipo}\n`;
            detalles += `‚≠ê Puntos: ${canje.puntos}\n`;
            detalles += `üí≥ Fuente: ${fuente === 'puntos' ? 'Canje con puntos' : 'Pago con dinero'}\n`;
            detalles += `üìÖ Fecha: ${new Date(canje.created_at).toLocaleString('es-ES')}\n`;
            
            if (canje.fecha_inicio) {
                detalles += `üìÜ Fecha inicio: ${canje.fecha_inicio}\n`;
            }
            if (canje.fecha_fin) {
                detalles += `üìÜ Fecha fin: ${canje.fecha_fin}\n`;
            }
            
            detalles += `\n`;
            
            if (canje.tipo === 'promo_tiktok') {
                detalles += `üìπ LINK VIDEO:\n${datos.link_video || 'No proporcionado'}\n\n`;
                detalles += `üìù Instrucciones:\n${datos.instrucciones || 'Ninguna'}`;
            }
            if (canje.tipo === 'mastering_ia') {
                detalles += `üéµ Canci√≥n: ${datos.nombre_cancion || 'Sin nombre'}\n`;
                detalles += `‚¨áÔ∏è LINK DESCARGA:\n${datos.link_cancion || 'No proporcionado'}`;
            }
            if (canje.tipo === 'playlist_top' || canje.tipo === 'top_playlist') {
                detalles += `üìã Playlist: ${datos.playlist_nombre || 'No especificada'}\n`;
                detalles += `üë• Seguidores: ${datos.seguidores || 'No disponible'}\n`;
                detalles += `üîó Playlist ID: ${datos.playlist_id || 'No disponible'}`;
            }
            if (canje.tipo === 'redes_sociales') {
                detalles += `üì± Promoci√≥n en Instagram, TikTok y Facebook`;
            }
            
            if (canje.notas) {
                detalles += `\n\nüìù NOTAS:\n${canje.notas}`;
            }
            
            alert(detalles);
        }
        
        function filtrarCanjes(estado) {
            // Actualizar botones activos
            document.querySelectorAll('#tabCanjes .filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            if (estado === 'todos') {
                renderizarCanjes(todosCanjes);
            } else if (estado === 'aprobado') {
                // Incluir tanto 'aprobado' como 'completado'
                const filtrados = todosCanjes.filter(c => c.estado === 'aprobado' || c.estado === 'completado');
                renderizarCanjes(filtrados);
            } else {
                const filtrados = todosCanjes.filter(c => c.estado === estado);
                renderizarCanjes(filtrados);
            }
        }
        
        async function aprobarCanje(id, fuente) {
            const canje = todosCanjes.find(c => c.id === id);
            if (!canje) return;
            
            const datos = canje.datos_extra || {};
            let mensaje = `‚úÖ ¬øAPROBAR este canje?\n\n`;
            mensaje += `üë§ Curador: ${canje.curador_nombre}\n`;
            mensaje += `üéÅ Servicio: ${serviciosNombres[canje.tipo] || canje.tipo}\n`;
            if (datos.playlist_nombre) {
                mensaje += `üìã Playlist: ${datos.playlist_nombre}\n`;
            }
            mensaje += `‚≠ê Puntos: ${canje.puntos}`;
            
            if (!confirm(mensaje)) {
                return;
            }
            
            try {
                const tabla = fuente === 'puntos' ? 'canjes' : 'canjes_servicios';
                
                const { error } = await supabaseClient
                    .from(tabla)
                    .update({ 
                        estado: fuente === 'puntos' ? 'aprobado' : 'completado',
                        completado_at: new Date().toISOString()
                    })
                    .eq('id', id);
                
                if (error) throw error;
                
                // Si es un canje de playlist TOP, marcar la playlist como destacada
                if ((canje.tipo === 'top_playlist' || canje.tipo === 'playlist_top') && datos.playlist_id) {
                    await supabaseClient
                        .from('playlists')
                        .update({ destacada: true })
                        .eq('id', datos.playlist_id);
                }
                
                alert('‚úÖ Canje APROBADO correctamente');
                cargarCanjes();
                
            } catch (err) {
                console.error('Error:', err);
                alert('‚ùå Error: ' + err.message);
            }
        }
        
        async function rechazarCanje(id, fuente) {
            const canje = todosCanjes.find(c => c.id === id);
            if (!canje) return;
            
            const motivo = prompt('üìù Motivo del rechazo (opcional):') || 'Sin motivo especificado';
            
            if (!confirm(`‚ùå ¬øRECHAZAR este canje?\n\nSe devolver√°n ${canje.puntos} puntos al curador.`)) {
                return;
            }
            
            try {
                const tabla = fuente === 'puntos' ? 'canjes' : 'canjes_servicios';
                
                // Actualizar estado del canje
                const { error } = await supabaseClient
                    .from(tabla)
                    .update({ 
                        estado: 'rechazado',
                        notas: (canje.notas || '') + ' | RECHAZADO: ' + motivo
                    })
                    .eq('id', id);
                
                if (error) throw error;
                
                // Si es canje con puntos, devolver los puntos al curador
                if (fuente === 'puntos' && canje.curador_id) {
                    // Obtener puntos actuales
                    const { data: usuario } = await supabaseClient
                        .from('usuarios')
                        .select('puntos')
                        .eq('id', canje.curador_id)
                        .single();
                    
                    if (usuario) {
                        const nuevosPuntos = (usuario.puntos || 0) + canje.puntos;
                        await supabaseClient
                            .from('usuarios')
                            .update({ puntos: nuevosPuntos })
                            .eq('id', canje.curador_id);
                    }
                }
                
                alert(`‚ùå Canje RECHAZADO.\n\n${fuente === 'puntos' ? `Se devolvieron ${canje.puntos} puntos al curador.` : ''}`);
                cargarCanjes();
                
            } catch (err) {
                console.error('Error:', err);
                alert('‚ùå Error: ' + err.message);
            }
        }
        
        async function completarCanje(id) {
            const notas = prompt('A√±ade una nota sobre el servicio completado (opcional):') || '';
            
            if (!confirm('‚úÖ ¬øMarcar este canje como COMPLETADO?')) {
                return;
            }
            
            try {
                const { error } = await supabaseClient
                    .from('canjes_servicios')
                    .update({ 
                        estado: 'completado',
                        completado_at: new Date().toISOString(),
                        notas: notas
                    })
                    .eq('id', id);
                
                if (error) throw error;
                
                alert('‚úÖ Canje marcado como completado');
                cargarCanjes();
                
            } catch (err) {
                console.error('Error:', err);
                alert('‚ùå Error: ' + err.message);
            }
        }

        // ========================================
        // PEDIDOS UNIFICADOS
        // ========================================
        let todosPedidos = [];
        let filtroActual = 'todos';
        
        async function cargarTodosPedidos() {
            try {
                todosPedidos = [];
                
                // Cargar SmartLinks
                const { data: smartlinks } = await supabaseClient
                    .from('smartlinks')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (smartlinks) {
                    smartlinks.forEach(s => {
                        todosPedidos.push({
                            ...s,
                            tipo: 'smartlink',
                            tipoLabel: 'üîó SmartLink',
                            precio: '1.99‚Ç¨',
                            detalles: `${s.nombre_cancion} - ${s.nombre_artista}`
                        });
                    });
                }
                
                // Cargar Mastering
                const { data: mastering } = await supabaseClient
                    .from('solicitudes_mastering')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (mastering) {
                    mastering.forEach(m => {
                        const intensidades = { light: 'Ligero', medium: 'Medio', heavy: 'Intenso' };
                        todosPedidos.push({
                            ...m,
                            tipo: 'mastering',
                            tipoLabel: 'üéõÔ∏è Mastering',
                            precio: m.es_gratuito ? 'GRATIS' : '4.99‚Ç¨',
                            detalles: `${m.nombre_pista} (${intensidades[m.intensidad] || m.intensidad})`
                        });
                    });
                }
                
                // Cargar An√°lisis
                const { data: analisis } = await supabaseClient
                    .from('solicitudes_analisis')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (analisis) {
                    analisis.forEach(a => {
                        todosPedidos.push({
                            ...a,
                            tipo: 'analisis',
                            tipoLabel: 'üìä An√°lisis',
                            precio: 'GRATIS',
                            detalles: `Perfil: ${a.spotify_url?.substring(0, 50)}...`,
                            artista_nombre: a.usuario_nombre,
                            artista_email: a.usuario_email
                        });
                    });
                }
                
                // Ordenar por fecha
                todosPedidos.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                
                // Actualizar contadores
                document.getElementById('pedidosSmartlinks').textContent = smartlinks?.filter(s => s.estado === 'pendiente').length || 0;
                document.getElementById('pedidosMastering').textContent = mastering?.filter(m => m.estado === 'pendiente').length || 0;
                document.getElementById('pedidosAnalisis').textContent = analisis?.filter(a => a.estado === 'pendiente').length || 0;
                
                renderizarPedidos();
                
            } catch (err) {
                console.error('Error cargando pedidos:', err);
            }
        }
        
        function filtrarPedidos(filtro) {
            filtroActual = filtro;
            
            // Actualizar botones
            document.querySelectorAll('#tabPedidos .filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            renderizarPedidos();
        }
        
        function renderizarPedidos() {
            const tbody = document.getElementById('tablaPedidos');
            
            let pedidosFiltrados = todosPedidos;
            
            if (filtroActual === 'pendiente') {
                pedidosFiltrados = todosPedidos.filter(p => p.estado === 'pendiente');
            } else if (filtroActual === 'completado') {
                pedidosFiltrados = todosPedidos.filter(p => p.estado === 'completado');
            } else if (filtroActual !== 'todos') {
                pedidosFiltrados = todosPedidos.filter(p => p.tipo === filtroActual);
            }
            
            if (pedidosFiltrados.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 2rem; color: rgba(255,255,255,0.5);">No hay pedidos</td></tr>';
                return;
            }
            
            tbody.innerHTML = pedidosFiltrados.map(p => {
                const fecha = new Date(p.created_at).toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' });
                
                const tipoColors = {
                    smartlink: '#7c3aed',
                    mastering: '#ec4899',
                    analisis: '#8b5cf6'
                };
                
                const estadoBadge = p.estado === 'pendiente' 
                    ? '<span style="background: #f59e0b; color: white; padding: 0.25rem 0.5rem; border-radius: 0.5rem; font-size: 0.75rem;">‚è≥ Pendiente</span>'
                    : '<span style="background: #10b981; color: white; padding: 0.25rem 0.5rem; border-radius: 0.5rem; font-size: 0.75rem;">‚úÖ Completado</span>';
                
                let acciones = '';
                if (p.estado === 'pendiente') {
                    acciones = `<button onclick="completarPedido('${p.id}', '${p.tipo}')" style="background: #10b981; color: white; border: none; padding: 0.5rem 0.75rem; border-radius: 0.5rem; cursor: pointer; font-size: 0.85rem;">‚úÖ Completar</button>`;
                } else {
                    acciones = `<span style="color: rgba(255,255,255,0.5); font-size: 0.8rem;">${new Date(p.completado_at).toLocaleDateString('es-ES')}</span>`;
                }
                
                return `
                    <tr>
                        <td>
                            <span style="background: ${tipoColors[p.tipo]}; color: white; padding: 0.25rem 0.5rem; border-radius: 0.5rem; font-size: 0.75rem; font-weight: 700;">
                                ${p.tipoLabel}
                            </span>
                        </td>
                        <td>
                            <div style="font-weight: 600;">${p.artista_nombre || p.nombre_artista || 'Sin nombre'}</div>
                            <div style="font-size: 0.75rem; color: rgba(255,255,255,0.6);">${p.artista_email || ''}</div>
                        </td>
                        <td style="max-width: 200px;">
                            <div style="font-size: 0.85rem;">${p.detalles}</div>
                            ${p.descripcion ? `<div style="font-size: 0.75rem; color: rgba(255,255,255,0.5); margin-top: 0.25rem;">${p.descripcion.substring(0, 50)}...</div>` : ''}
                        </td>
                        <td style="font-weight: 700; color: ${p.precio === 'GRATIS' ? '#10b981' : '#f59e0b'};">${p.precio}</td>
                        <td>${estadoBadge}</td>
                        <td style="font-size: 0.8rem;">${fecha}</td>
                        <td>${acciones}</td>
                    </tr>
                `;
            }).join('');
        }
        
        async function completarPedido(id, tipo) {
            let tabla = '';
            let mensaje = '';
            let datosExtra = {};
            
            switch(tipo) {
                case 'smartlink':
                    tabla = 'smartlinks';
                    const slug = prompt('Introduce el SLUG del SmartLink creado:');
                    if (!slug) return;
                    datosExtra = { slug: slug };
                    mensaje = '‚úÖ SmartLink completado.\n\nüìß Recuerda enviar email al cliente con el link.';
                    break;
                    
                case 'mastering':
                    tabla = 'solicitudes_mastering';
                    const resultadoMaster = prompt('Introduce el link de descarga del archivo masterizado:');
                    if (!resultadoMaster) return;
                    datosExtra = { resultado_url: resultadoMaster };
                    mensaje = '‚úÖ Mastering completado.\n\nüìß Recuerda enviar email al cliente con el link de descarga.';
                    break;
                    
                case 'analisis':
                    tabla = 'solicitudes_analisis';
                    const resultado = prompt('Introduce el resultado del an√°lisis (breve resumen):');
                    if (!resultado) return;
                    datosExtra = { resultado: resultado };
                    mensaje = '‚úÖ An√°lisis completado.\n\nüìß Recuerda enviar email al cliente con los resultados.';
                    break;
            }
            
            try {
                const { error } = await supabaseClient
                    .from(tabla)
                    .update({ 
                        estado: 'completado',
                        completado_at: new Date().toISOString(),
                        ...datosExtra
                    })
                    .eq('id', id);
                
                if (error) throw error;
                
                alert(mensaje);
                cargarTodosPedidos();
                
            } catch (err) {
                console.error('Error:', err);
                alert('‚ùå Error: ' + err.message);
            }
        }
    </script>
</body>
</html>
