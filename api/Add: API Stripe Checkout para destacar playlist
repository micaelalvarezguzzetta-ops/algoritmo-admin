export default async function handler(req, res) {
    // CORS headers - SIEMPRE PRIMERO
    res.setHeader('Access-Control-Allow-Origin', '*');
    res.setHeader('Access-Control-Allow-Methods', 'GET, POST, PUT, DELETE, OPTIONS');
    res.setHeader('Access-Control-Allow-Headers', 'Content-Type, Authorization');

    // Preflight
    if (req.method === 'OPTIONS') {
        return res.status(200).end();
    }

    if (req.method !== 'POST') {
        return res.status(405).json({ error: 'Method not allowed' });
    }

    const STRIPE_KEY = process.env.STRIPE_SECRET_KEY;
    
    if (!STRIPE_KEY) {
        return res.status(500).json({ error: 'Stripe no configurado en servidor' });
    }

    const body = req.body || {};
    const { curador_id, curador_nombre, curador_email, playlist_id, playlist_nombre } = body;

    if (!curador_id || !playlist_id || !curador_email) {
        return res.status(400).json({ error: 'Faltan datos requeridos' });
    }

    try {
        const params = new URLSearchParams();
        params.append('payment_method_types[]', 'card');
        params.append('line_items[0][price_data][currency]', 'eur');
        params.append('line_items[0][price_data][product_data][name]', 'Destacar Playlist: ' + (playlist_nombre || 'Playlist'));
        params.append('line_items[0][price_data][product_data][description]', 'Aparece en TOP durante 30 dias');
        params.append('line_items[0][price_data][unit_amount]', '1499');
        params.append('line_items[0][quantity]', '1');
        params.append('mode', 'payment');
        params.append('success_url', 'https://algoritmoenmovimiento.com/?destacar_success=true&playlist_id=' + playlist_id);
        params.append('cancel_url', 'https://algoritmoenmovimiento.com/?destacar_cancel=true');
        params.append('customer_email', curador_email);
        params.append('metadata[curador_id]', curador_id);
        params.append('metadata[curador_nombre]', curador_nombre || '');
        params.append('metadata[curador_email]', curador_email);
        params.append('metadata[playlist_id]', playlist_id);
        params.append('metadata[playlist_nombre]', playlist_nombre || '');
        params.append('metadata[tipo]', 'destacar_playlist');

        const response = await fetch('https://api.stripe.com/v1/checkout/sessions', {
            method: 'POST',
            headers: {
                'Authorization': 'Bearer ' + STRIPE_KEY,
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: params.toString()
        });

        const data = await response.json();

        if (response.ok && data.url) {
            return res.status(200).json({ success: true, url: data.url, session_id: data.id });
        } else {
            return res.status(500).json({ error: data.error?.message || 'Error Stripe', details: data });
        }

    } catch (err) {
        return res.status(500).json({ error: err.message || 'Error desconocido' });
    }
}
